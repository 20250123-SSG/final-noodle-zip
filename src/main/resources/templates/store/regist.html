<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <div th:replace="~{fragments/head :: head}"></div>

  <!-- SPECIFIC CSS -->
  <link href="/css/submit.css" rel="stylesheet">
  <link href="/css/detail-page-delivery.css" rel="stylesheet">
  <link href="/css/booking-sign_up.css" rel="stylesheet">

  <!-- YOUR CUSTOM CSS -->
  <link href="/css/store-regist.css" rel="stylesheet">

</head>

<body class="margin_sticky">


  <!-- /header -->
  <header th:replace="~{fragments/subHeader :: subHeader}"></header>

  <main class="bg_gray pattern">
    <div class="container margin_60_40">
      <div class="row justify-content-center">
        <div class="col-xl-6 col-lg-8">

          <!-- form 태그 시작 -->
          <form method="post" action="/store/regist" enctype="multipart/form-data" id="register" autocomplete="off">

            <div class="box_booking_2 style_2">

              <div class="head">
                <div class="title">
                  <h3>가게 등록</h3>
                </div>
              </div>

              <div class="main">

                <!-- ① 이미지 업로드 -->
                <label for="image-input" id="image-upload-area"
                       style="border: 2px dashed #ccc; padding: 40px 30px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center;">
                  <span id="upload-text">Drop files here to upload</span>
                  <img id="preview-image" src="" alt="업로드 미리보기 이미지"
                       style="max-width: 100%; display: none; margin-top: 10px;"/>
                </label>

                <input type="file" id="image-input" name="storeMainImage" accept="image/*"
                       style="opacity: 0; position: absolute; width: 0; height: 0;"/>

                <!-- ② 가게명 / ③ 도로명 주소 API / ④ 전화번호 -->
                <div class="row mb-3">
                  <div class="row mb-3">
                    <div class="col-md-6 position-relative">
                      <!-- 가게명 -->
                      <label for="storeName" class="form-label visually-hidden">가게명</label>
                      <input type="text" id="storeName" name="storeName" class="form-control mb-3" placeholder="가게명"
                             required/>
                      <!-- 전화번호 -->
                      <div class="form-group mb-0">
                        <label for="phonePrefix" style="font-weight: normal;">전화번호</label>
                        <div class="d-flex gap-2">
                          <!-- 앞자리 선택 -->
                          <select id="phonePrefix" name="phonePrefix" class="form-select" style="max-width: 100px;">
                            <option value="" selected>선택</option>
                            <option value="02">02</option>
                            <option value="031">031</option>
                            <option value="032">032</option>
                            <option value="042">042</option>
                            <option value="051">051</option>
                            <option value="053">053</option>
                            <option value="062">062</option>
                            <option value="041">041</option>
                            <option value="043">043</option>
                            <option value="054">054</option>
                            <option value="055">055</option>
                            <option value="061">061</option>
                            <option value="063">063</option>
                            <option value="044">044</option>
                            <option value="010">010</option>
                            <option value="011">011</option>
                            <!-- 필요한 번호 추가 -->
                          </select>

                          <!-- 나머지 번호 입력 -->
                          <label for="phonePrefixInput" class="visually-hidden">전화번호 직접입력</label>
                          <input type="text" id="phonePrefixInput" name="phonePrefixInput" class="form-control"
                                 placeholder="직접입력" style="max-width: 100px;" maxlength="4"/>

                          <label for="phoneRest" class="visually-hidden">전화번호 뒷자리</label>
                          <input type="text" id="phoneRest" name="phoneRest" class="form-control"
                                 placeholder="1234-5678" maxlength="9" required/>
                        </div>
                        <!-- 합친 전화번호를 form submit 시 hidden 필드로 만들기 -->
                        <input type="hidden" id="phone" name="phone"/>
                      </div>
                    </div>

                    <div class="col-md-6 position-relative">
                      <!-- 주소 입력 영역 -->
                      <div class="address-group">
                        <!-- 도로명 주소 -->
                        <label for="address-api" class="visually-hidden">도로명 주소</label>
                        <input type="text" id="address-api" name="address" class="form-control" placeholder="도로명 주소"
                               readonly/>
                        <!-- 우편번호 (hidden) -->
                        <input type="hidden" id="zipcode" name="zipcode"/>
                        <!-- 상세주소 -->
                        <label for="store_detail_input" class="visually-hidden">상세 주소 입력</label>
                        <input
                          type="text"
                          id="store_detail_input"
                          name="store_detail_input"
                          class="form-control mt-2"
                          placeholder="상세 주소 입력"
                          autocomplete="off"
                          spellcheck="false"
                          inputmode="text"
                        />
                        <!-- 숨김 필드: 위도, 경도, 법정코드 -->
                        <input type="hidden" id="storeLat" name="storeLat"/>
                        <input type="hidden" id="storeLng" name="storeLng"/>
                        <input type="hidden" id="storeLegalCode" name="storeLegalCode"/>

                        <!-- 주소 검색 버튼 -->
                        <button type="button" class="btn mt-2" id="searchAddressBtn"
                                style="background-color: #f39c12; color: white; border: none;">
                          주소 검색
                        </button>
                      </div>
                    </div>
                  </div>


                  <!-- 사업자등록번호 입력 -->
                  <div class="mb-3">
                    <label for="businessRegistrationNumber" class="form-label">사업자등록번호</label>
                    <input type="text" id="businessRegistrationNumber" name="businessRegistrationNumber"
                           class="form-control" placeholder="사업자등록번호 입력" maxlength="10" pattern="\d{10}"
                           title="숫자 10자리 입력" required/>
                  </div>

                  <!-- ⑤ 요일별 영업시간 -->
                  <div class="box_general padding_bottom">
                    <div class="header_box version_2">
                      <h2><i class="fa fa-clock-o"></i>영업 시간</h2>
                    </div>
                    <div id="opening-schedule"></div>
                  </div>

                  <!-- ⑥ 지역카드, 유아 동반, 주차 : 라디오 · 체크박스 -->
                  <div class="mb-4">

                    <!-- 지역카드 사용 가능 -->
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" id="localCard" name="isLocalCard">
                      <label class="form-check-label" for="localCard">지역카드 사용 가능</label>
                    </div>

                    <!-- 유아 동반 가능 -->
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" id="childAllowed" name="isChildAllowed">
                      <label class="form-check-label" for="childAllowed">유아 동반 가능</label>
                    </div>


                    <input type="hidden" name="isLocalCard" id="isLocalCardValue">
                    <input type="hidden" name="isChildAllowed" id="isChildAllowedValue">

                    <!-- 주차 -->
                    <div class="mt-3">
                      <label class="form-label me-3">주차</label>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="hasParking" id="parkingFree" value="FREE">
                        <label class="form-check-label" for="parkingFree">무료</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="hasParking" id="parkingPaid" value="PAID">
                        <label class="form-check-label" for="parkingPaid">유료</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="hasParking" id="parkingNone"
                               value="NOT_AVAILABLE">
                        <label class="form-check-label" for="parkingNone">불가</label>
                      </div>
                    </div>

                  </div>

                  <!-- ⑦ 사장님 한 줄 소개 -->
                  <div class="owner-intro-wrapper" style="width: 100%;">
                    <label for="owner-intro" style="font-weight: bold; color: #2c3e50;">
                      사장님 한 줄 소개
                    </label>
                    <textarea
                      id="owner-intro"
                      name="ownerComment"
                      class="form-control"
                      rows="8"
                      placeholder="매장 소개를 적어주세요.
												• 주말/공휴일 영업 여부
												• 유료 주차일 경우, 꼭! 적어주세요.(ex: 1시간당 2,000원)"
									maxlength="200"
                                    style="white-space: pre-line; line-height: 1.5; height: 140px;"
                    ></textarea>

							<small id="owner-intro-count" class="text-muted">0 / 200자</small>

							<div id="owner-intro-hint"
								 style="
									margin-top: 8px;
									color: #888;
									font-size: 0.9em;
									user-select: none;
									white-space: pre-line;
									line-height: 1.3;
									transition: opacity 0.3s ease;
									opacity: 1;
								"
                            >
                    </div>
                  </div>
                </div>
              </div>
            </div>

						<!-- 메뉴등록 -->
            <div class="box_booking_2 style_2">
              <div class="head">
                <div class="title">
                  <h3>메뉴 등록</h3>
                </div>
              </div>

              <div class="main">
                <!-- 메뉴 항목들이 추가될 컨테이너 -->
                <div id="menu-items">
                  <!-- 초기 메뉴 항목 하나 예시 -->
                  <div class="menu-item row align-items-center mb-4">
                    <!-- 이미지 업로드 영역 -->
                    <div class="col-md-4">
                      <div class="menu-image-upload"
                           style="border: 2px dashed #ccc; padding: 30px 20px; text-align: center; cursor: pointer; height: 180px;">
                        <p style="margin-top: 10px;">Drop files here to upload</p>
                        <input type="file" name="menus[0].menuImageFile" class="menu-image-input"/>
                        <img class="menu-preview-image" src="" alt="메뉴 이미지 미리보기"
                             style="max-width: 100%; max-height: 120px; display: none; margin-top: 10px;"/>
                      </div>
                    </div>

                    <!-- 메뉴 정보 -->
                    <div class="col-md-8">
                      <div class="row">
                        <div class="col-md-4">
                          <label for="menuName0" class="visually-hidden">메뉴 이름</label>
                          <input type="text" id="menuName0" name="menus[0].menuName" class="form-control"
                                 placeholder="메뉴 이름" required/>
                        </div>

                        <div class="col-md-6 mb-2">
                          <div class="input-group">
                            <label for="price0" class="visually-hidden">가격</label>
                            <input type="number" id="price0" name="menus[0].price" class="form-control" placeholder="가격"
                                   min="0" step="100" required/>
                            <span class="input-group-text">원</span>
                          </div>
                        </div>

                        <div class="col-md-8 mb-2 d-flex gap-2">
                          <label for="ramenCategoryId0" class="visually-hidden">카테고리 선택</label>
                          <select id="ramenCategoryId0" name="menus[0].ramenCategoryId"
                                  class="form-select form-select-sm scrollable-select" style="flex: 1;">
                            <option value="" disabled selected>카테고리 선택</option>
                            <!-- 카테고리 옵션들 -->
                          </select>
                          <label for="ramenSoupId0" class="visually-hidden">육수 선택</label>
                          <select id="ramenSoupId0" name="menus[0].ramenSoupId"
                                  class="form-select form-select-sm scrollable-select" style="flex: 1;">
                            <option value="" disabled selected>육수 선택</option>
                            <!-- 육수 옵션들 -->
                          </select>
                        </div>

                        <div class="col-md-12 mb-2 d-flex gap-3 align-items-start">
                          <div class="col-md-6 mt-2">
                            <label for="menuDescription0" class="visually-hidden">메뉴 설명</label>
                              <textarea
                                      id="menuDescription0"
                                      name="menus[0].menuDescription"
                                      class="form-control"
                                      rows="2"
                                      placeholder="설명"
                                      maxlength="100"
                              ></textarea>
                              <small id="menuDescription-count-0" class="text-muted">0 / 100자</small>
                          </div>
                          <div>
                            <label class="form-label d-block">기본 토핑 선택</label>
                            <div class="topping-tags" data-menu-index="0"></div>
                            <div class="default-toppings-container"></div>
                          </div>
                        </div>
                        <div class="text-end mt-2">
                          <button type="button" class="btn btn-sm btn-outline-danger remove-menu">메뉴 삭제</button>
                        </div>
                        <div id="extra-toppings-container-0" style="display:none;"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 메뉴 추가 버튼 -->
                <div class="text-start mb-3">
                  <button type="button" id="add-menu" class="btn btn-sm btn-outline-primary">+ 메뉴 추가</button>
                </div>

              </div>
              <div class="main">

                <div class="topping-item row align-items-center mb-4">

                  <!-- 토핑 선택 영역 -->
                  <div class="d-flex gap-2 align-items-center mb-2">
                    <label for="topping-select" class="form-label mb-0">토핑 선택</label>
                    <select id="topping-select" class="form-select" style="width: 200px;">
                      <option value="">-- 토핑 선택 --</option>
                      <th:block th:each="topping : ${toppings}">
                        <option th:value="${topping.id}" th:text="${topping.name}"></option>
                      </th:block>
                    </select>
                    <input type="number" id="topping-price" class="form-control" placeholder="가격 (원)" style="width: 120px;" min="0" step="100"/>
                    <button type="button" class="btn btn-sm btn-outline-primary add-topping-btn">+ 토핑 추가</button>
                  </div>

                  <!-- 여기에 추가된 토핑들이 렌더링됨 -->
                  <div id="store-extra-toppings-container" class="d-flex flex-column gap-2 mt-2"></div>
                </div>

              </div>

                <!-- 등록 버튼 -->
              <div class="text-center">
                <button type="submit" class="btn btn-success btn-lg">등록하기</button>
              </div>
            </div>
          </form>


        </div>
      </div>
    </div>
  </main>
  <!--/footer-->
	<footer th:replace="~{fragments/footer :: footer}"></footer>

  <!-- ❗JS 스크립트 ❗ -->


  <!-- COMMON SCRIPTS -->
  <script src="/js/common_scripts.min.js"></script>
  <script src="/js/common_func.js"></script>
  <script src="/assets/validate.js"></script>

  <!-- 카카오 다음 우편번호 API 스크립트 -->
  <script src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js" charset="utf-8"></script>
  <script type="text/javascript"
          src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d8455fa8f84607ce70b0cd1184c74538&libraries=services"></script>

  <script>
    /* ========== 주소 검색 (카카오) ========== */
    function openPostcode() {
      new daum.Postcode({
        oncomplete: function (data) {
          const roadAddress = data.roadAddress;
          const zonecode = data.zonecode;

          document.getElementById("address-api").value = roadAddress;
          document.getElementById("zipcode").value = zonecode;
          document.getElementById("store_detail_input").focus();

          fetch("/location/info", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            credentials: 'include',
            body: JSON.stringify({roadAddress})
          })
            .then(res => {
              return res.json();
            })
            .then(data => {
              document.getElementById("storeLat").value = data.storeLat || '';
              document.getElementById("storeLng").value = data.storeLng || '';
              document.getElementById("storeLegalCode").value = data.storeLegalCode || '';
            })
            .catch(err => console.error("주소 정보 조회 실패:", err));
        }
      }).open();
    }

    document.getElementById("searchAddressBtn").addEventListener("click", openPostcode);
    document.getElementById("address-api").addEventListener("click", openPostcode);


    /* ========== 전화번호 입력 처리 ========== */
    const phonePrefix = document.getElementById('phonePrefix');
    const phonePrefixInput = document.getElementById('phonePrefixInput');
    const phoneRest = document.getElementById('phoneRest');
    const phoneHidden = document.getElementById('phone');

    // 전화번호 입력 필드 활성/비활성 토글 함수
    function togglePrefixInputs() {
      if (phonePrefix.value && phonePrefix.value !== "") {
        phonePrefixInput.value = '';
        phonePrefixInput.disabled = true;
        phonePrefix.disabled = false;
      } else if (phonePrefixInput.value.trim() !== '') {
        phonePrefix.value = '';
        phonePrefix.disabled = true;
        phonePrefixInput.disabled = false;
      } else {
        phonePrefix.disabled = false;
        phonePrefixInput.disabled = false;
      }
    }

    phonePrefix.addEventListener('change', togglePrefixInputs);
    phonePrefixInput.addEventListener('input', togglePrefixInputs);

    togglePrefixInputs();

    // 자동 하이픈 함수
    phoneRest.addEventListener('input', function (e) {
      const input = e.target;
      let numbers = input.value.replace(/\D/g, '');

      if (numbers.length <= 3) {
        input.value = numbers;
      } else if (numbers.length <= 7) {
        input.value = numbers.replace(/(\d{3})(\d+)/, '$1-$2');
      } else {
        input.value = numbers.replace(/(\d{4})(\d{4})/, '$1-$2');
      }
    });

    function isMenuNameDuplicated() {
      const nameInputs = Array.from(document.querySelectorAll('input[name$=".menuName"]'));
      const names = nameInputs.map(input => input.value.trim()).filter(Boolean);

      const nameCount = {};
      for (let name of names) {
        if (!nameCount[name]) nameCount[name] = 1;
        else nameCount[name]++;
      }

      const duplicates = Object.entries(nameCount).filter(([name, count]) => count > 1);
      if (duplicates.length > 0) {
        alert(`메뉴 이름 "${duplicates[0][0]}" 이(가) 중복됩니다. 다른 이름으로 바꿔주세요.`);
        return true;
      }
      return false;
    }

    // SUBMIT 여기가 제출 버튼임!!

    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("register");

      form.addEventListener("submit", async function (e) {
        e.preventDefault(); // 기본 제출 막기

        const formData = new FormData();

        // 1. 대표 이미지
        const imageInput = document.getElementById("image-input");
        if (imageInput && imageInput.files.length > 0) {
          formData.append("storeMainImage", imageInput.files[0]);
        }

        // 2. 메뉴 이미지들
        document.querySelectorAll('.menu-item').forEach((item, idx) => {
          const menuImgInput = item.querySelector('.menu-image-input');
          if (menuImgInput && menuImgInput.files.length > 0) {
            formData.append(`menus[${idx}].menuImageFile`, menuImgInput.files[0]);
          }
        });

        // 3. 나머지 입력값 (storeData 객체)
        const storeData = {};

        storeData.storeName = document.getElementById("storeName").value;
        storeData.phone = document.getElementById("phone").value;
        storeData.address = document.getElementById("address-api").value;
        storeData.zipcode = document.getElementById("zipcode").value;
        storeData.storeDetailInput = document.getElementById("store_detail_input").value;
        storeData.storeLat = document.getElementById("storeLat").value;
        storeData.storeLng = document.getElementById("storeLng").value;
        storeData.storeLegalCode = document.getElementById("storeLegalCode").value;
        storeData.businessRegistrationNumber = document.getElementById("businessRegistrationNumber").value;
        storeData.ownerComment = document.getElementById("owner-intro").value;

        // isLocalCard / isChildAllowed / parking
        storeData.isLocalCard = document.getElementById("localCard").checked;
        storeData.isChildAllowed = document.getElementById("childAllowed").checked;
        storeData.hasParking = document.querySelector('input[name="hasParking"]:checked')?.value;

        // 4. 영업시간 (요일별 스케줄)
        storeData.weekSchedule = [];
        for (let i = 0; i < 7; i++) {
          storeData.weekSchedule.push({
            dayOfWeek: document.querySelector(`[name="weekSchedule[${i}].dayOfWeek"]`).value,
            openingAt: document.querySelector(`[name="weekSchedule[${i}].openingAt"]`).value,
            closingAt: document.querySelector(`[name="weekSchedule[${i}].closingAt"]`).value,
            isClosedDay: document.getElementById(`closed-day-${i}`).value === "true"
          });
        }

        // 5. 메뉴 리스트
        storeData.menus = [];
        document.querySelectorAll('.menu-item').forEach((menu, idx) => {
          const menuDto = {
            menuName: menu.querySelector(`[name="menus[${idx}].menuName"]`).value,
            price: menu.querySelector(`[name="menus[${idx}].price"]`).value,
            menuDescription: menu.querySelector(`[name="menus[${idx}].menuDescription"]`).value,
            ramenCategoryId: menu.querySelector(`[name="menus[${idx}].ramenCategoryId"]`).value,
            ramenSoupId: menu.querySelector(`[name="menus[${idx}].ramenSoupId"]`).value,
            defaultToppingIds: Array.from(
                    menu.querySelectorAll(`input[name="menus[${idx}].defaultToppingIds"]`)
            ).map(input => input.value)
          };

          storeData.menus.push(menuDto);
        });

        // 6. 추가 토핑 수집
        storeData.extraToppings = [];
        document.querySelectorAll(".store-topping-btn.btn-success").forEach(btn => {
          const toppingId = parseInt(btn.dataset.id);
          const priceInput = document.querySelector(`.topping-price-input[data-id="${toppingId}"]`);
          const price = parseInt(priceInput?.value || '0', 10);

          if (!isNaN(toppingId)) {
            storeData.extraToppings.push({
              toppingId: toppingId,
              price: price
            });
          }
        });

        console.log("보낼 storeData:", storeData); // 확인용

        // 7. JSON을 Blob으로 FormData에 담기
        const dtoBlob = new Blob([JSON.stringify(storeData)], {
          type: "application/json;charset=utf-8"
        });
        formData.append("dto", dtoBlob);

        // 8. 서버로 전송
        try {
          const response = await fetch("/store/regist", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            const data = await response.json();
            alert("등록 성공!");
            window.location.href = `/store/detail/${data.storeId}`;
          } else {
            const errorData = await response.json();
            alert("등록 실패: " + (errorData?.message || `서버 오류 (${response.status})`));
            console.error("서버 응답:", errorData);
          }
        } catch (err) {
          console.error("등록 중 오류 발생:", err);
          alert("서버 요청 중 오류가 발생했습니다.");
        }
      });
    });

    /* ========== 대표 이미지 업로드 미리보기 ========== */

    // 대표 이미지 선택 시 미리보기 띄우기
    document.getElementById('image-input').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const preview = document.getElementById('preview-image');
        const uploadText = document.getElementById('upload-text');
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.src = e.target.result;
          preview.style.display = 'block';
          uploadText.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    });

    let menuIndex = 1;
    const menuList = document.getElementById('menu-items');
    const template = document.querySelector('.menu-item');
    const addButton = document.getElementById('add-menu');

    /* ========== 영업시간 closed ========== */

    document.querySelectorAll('select[name^="weekSchedule"]').forEach(select => {
      select.addEventListener('change', e => {
        const name = e.target.name;
        const match = name.match(/\[(\d+)\]/);
        if (match) {
          const idx = Number(match[1]);
          checkClosed(idx);
        }
      });
    });

		/* ========== 메뉴 추가 버튼 클릭 시 ========== */

    addButton.addEventListener('click', () => {
      const clone = template.cloneNode(true);

      // 메뉴 폼 초기화
      clone.querySelectorAll('input, textarea').forEach(input => {
        if (input.type === 'file') {
          input.value = null;
        } else {
          input.value = '';
        }
      });

      clone.querySelectorAll('select').forEach(select => {
        select.selectedIndex = 0;
      });

      // 이미지 미리보기 초기화
      const preview = clone.querySelector('.menu-preview-image');
      const uploadText = clone.querySelector('.menu-image-upload p');
      if (preview && uploadText) {
        preview.src = '';
        preview.style.display = 'none';
        uploadText.style.display = 'block';
      }

      // 토핑 초기화
      clone.querySelectorAll('.topping-tag.selected').forEach(tag => tag.classList.remove('selected'));
      const toppingContainer = clone.querySelector('.default-toppings-container');
      if (toppingContainer) toppingContainer.innerHTML = '';

      menuList.appendChild(clone);

      // 인덱스 재정렬 & 각종 이벤트 재설정
      updateMenuIndices();
      setupToppingTags();
      setupExtraToppingButtons();
      setupMenuImageUpload(clone);
    });

    /* ========== 메뉴 삭제 버튼 클릭 시 ========== */

    function updateMenuIndices() {
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach((item, idx) => {
        item.querySelectorAll('input, textarea, select').forEach(el => {
          if (el.name) {
            el.name = el.name.replace(/\d+/, idx);
          }
          if (el.id) {
            el.id = el.id.replace(/\d+/, idx);
          }
        });

        // 토핑 관련 인덱스도 재지정
        const toppingTags = item.querySelector('.topping-tags');
        if (toppingTags) {
          toppingTags.dataset.menuIndex = idx;
        }

        const toppingInputs = item.querySelectorAll('input[name^="menus["][name$=".defaultToppingIds"]');
        toppingInputs.forEach(input => {
          input.name = `menus[${idx}].defaultToppingIds`;
        });
      });
    }

    // 메뉴 삭제 버튼 이벤트 위임 방식
    document.getElementById('menu-items').addEventListener('click', function (e) {
      if (e.target.classList.contains('remove-menu')) {
        const allMenus = document.querySelectorAll('.menu-item');
        if (allMenus.length > 1) {
          e.target.closest('.menu-item').remove();
          updateMenuIndices();
          setupToppingTags();
          setupExtraToppingButtons();
          setupMenuImageUpload(document);
        } else {
          alert("최소 한 개의 메뉴는 등록되어 있어야 합니다.");
        }
      }
    });

    /* ========== 기본 토핑 선택 기능 ========== */
    function setupToppingTags(context = document) {
      const target = context === document ? document : context;
      target.querySelectorAll('.topping-tag').forEach(tag => {
        tag.onclick = () => {
          tag.classList.toggle('selected');

          const menuItem = tag.closest('.menu-item');
          const menuIndex = menuItem.querySelector('.topping-tags').dataset.menuIndex;
          const toppingId = tag.dataset.id;
          const defaultContainer = menuItem.querySelector('.default-toppings-container');

          const existing = defaultContainer.querySelector(`input[value="${toppingId}"]`);

          if (tag.classList.contains('selected')) {
            if (!existing) {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = `menus[${menuIndex}].defaultToppingIds`;
              input.value = toppingId;
              defaultContainer.appendChild(input);
            }
          } else {
            if (existing) defaultContainer.removeChild(existing);
          }
        };
      });
    }

    /* ========== 메뉴 이미지 업로드 기능 ========== */
    function setupMenuImageUpload(area) {
      const uploadArea = area.querySelector('.menu-image-upload');
      if (uploadArea.dataset.listenerAdded) {
        return;
      }
      uploadArea.dataset.listenerAdded = 'true';

      const input = uploadArea.querySelector('.menu-image-input');
      input.setAttribute("accept", "image/*");
      const preview = uploadArea.querySelector('.menu-preview-image');
      const uploadText = uploadArea.querySelector('p');

      // 파일 input 숨기기
      input.style.display = 'none';

      uploadArea.addEventListener('click', () => input.click());

      ['dragover', 'dragleave'].forEach(evt =>
        uploadArea.addEventListener(evt, e => {
          e.preventDefault();
          uploadArea.style.borderColor = evt === 'dragover' ? '#007bff' : '#ccc';
        })
      );

      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ccc';
        const file = e.dataTransfer.files[0];
        if (file) {
          input.files = e.dataTransfer.files;
          preview.src = URL.createObjectURL(file);
          preview.style.display = 'block';
          uploadText.style.display = 'none';
        }
      });

      input.addEventListener('change', () => {
        const file = input.files[0];
        if (file) {
          preview.src = URL.createObjectURL(file);
          preview.style.display = 'block';
          uploadText.style.display = 'none';
        } else {
          // 파일 취소 시 미리보기와 텍스트 복원
          preview.style.display = 'none';
          uploadText.style.display = 'block';
        }
      });
    }

    /* ========== 한 줄 소개 ========== */
    const textarea = document.getElementById('owner-intro');
    const wrapper = textarea.closest('.owner-intro-wrapper');

    function toggleHint() {
      if (textarea.value.trim().length > 0) {
        wrapper.classList.add('text-filled');
      } else {
        wrapper.classList.remove('text-filled');
      }
    }

    textarea.addEventListener('input', toggleHint);
    window.addEventListener('DOMContentLoaded', toggleHint);

    /* ========== 요일별 영업시간 ========== */
    const days = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"];
    const dayLabels = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    function generateTimeOptions() {
      const options = [];
      for (let h = 0; h < 24; h++) {
        const hour = h % 12 === 0 ? 12 : h % 12;
        const meridian = h < 12 ? "AM" : "PM";
        const value = `${h.toString().padStart(2, '0')}:00`;
        const label = `${hour} ${meridian}`;
        options.push(`<option value="${value}">${label}</option>`);
      }
      return options.join("");
    }

    function checkClosed(event, index) {
      const open = document.querySelector(`[name="weekSchedule[${index}].openingAt"]`);
      const close = document.querySelector(`[name="weekSchedule[${index}].closingAt"]`);
      const closedInput = document.getElementById(`closed-day-${index}`);

      if (event.target.value === "CLOSED") {
        open.dataset.prevValue = open.value;
        close.dataset.prevValue = close.value;

        open.value = "CLOSED";
        close.value = "CLOSED";
        closedInput.value = "true";
      } else {
        closedInput.value = "false";

        if (event.target === open) {
          if (close.value === "CLOSED" && close.dataset.prevValue) {
            close.value = close.dataset.prevValue;
          }
        } else if (event.target === close) {
          if (open.value === "CLOSED" && open.dataset.prevValue) {
            open.value = open.dataset.prevValue;
          }
        }
      }
    }

    function renderOpeningSchedule() {
      const container = document.getElementById("opening-schedule");
      let html = "";
      for (let i = 0; i < days.length; i++) {
        html += `
		<div class="row mb-2 align-items-center">
			<div class="col-md-2">
				<label class="fix_spacing">${dayLabels[i]}</label>
				<input type="hidden" name="weekSchedule[${i}].dayOfWeek" value="${days[i]}">
				<input type="hidden" name="weekSchedule[${i}].isClosedDay" value="false" id="closed-day-${i}">
			</div>
			<div class="col-md-5">
				<select class="form-control"
						name="weekSchedule[${i}].openingAt"
						onchange="checkClosed(event, ${i})"
						data-prev-value="">
					<option value="">Opening Time</option>
					<option value="CLOSED">Closed</option>
					${generateTimeOptions()}
				</select>
			</div>
			<div class="col-md-5">
				<select class="form-control"
						name="weekSchedule[${i}].closingAt"
						onchange="checkClosed(event, ${i})"
						data-prev-value="">
					<option value="">Closing Time</option>
					<option value="CLOSED">Closed</option>
					${generateTimeOptions()}
				</select>
			</div>
		</div>`;
      }
      container.innerHTML = html;
    }
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      // renderOpeningSchedule
      renderOpeningSchedule();

      // ① 메뉴 설명 글자 수 - 최초 1개
      const firstDesc = document.getElementById("menuDescription0");
      const firstCounter = document.getElementById("menuDescription-count-0");
      if (firstDesc && firstCounter) {
        updateMenuDescriptionCharCount(firstDesc, "menuDescription-count-0");
      }

      // ② 메뉴 추가 시 설명 글자 수 추가
      const addMenuBtn = document.getElementById("add-menu");
      if (addMenuBtn) {
        addMenuBtn.addEventListener("click", () => {
          setTimeout(() => {
            const menuItems = document.querySelectorAll(".menu-item");
            const lastIndex = menuItems.length - 1;
            const newTextarea = document.getElementById(`menuDescription${lastIndex}`);
            const counterId = `menuDescription-count-${lastIndex}`;

            if (newTextarea && !document.getElementById(counterId)) {
              const counter = document.createElement("small");
              counter.id = counterId;
              counter.className = "text-muted";
              counter.textContent = "0 / 100자";
              newTextarea.insertAdjacentElement("afterend", counter);

              updateMenuDescriptionCharCount(newTextarea, counterId);
            }

            setupToppingAddButton(); // 새 토핑 추가 버튼에도 이벤트 다시 연결
          }, 100);
        });
      }

      // ③ 사장님 한 줄 소개 글자 수
      const introTextarea = document.getElementById("owner-intro");
      const countDisplay = document.getElementById("owner-intro-count");
      if (introTextarea && countDisplay) {
        const updateIntroCount = () => {
          countDisplay.textContent = `${introTextarea.value.length} / 200자`;
        };
        introTextarea.addEventListener("input", updateIntroCount);
        updateIntroCount();
      }

      // ④ 메뉴 이미지 미리보기
      document.querySelectorAll('.menu-image-input').forEach(input => {
        input.addEventListener('change', e => {
          const file = e.target.files[0];
          if (file) {
            const uploadArea = input.closest('.menu-image-upload');
            const menuPreview = uploadArea.querySelector('.menu-preview-image');
            const uploadText = uploadArea.querySelector('p');

            menuPreview.src = URL.createObjectURL(file);
            menuPreview.style.display = 'block';
            uploadText.style.display = 'none';
          }
        });
      });

      // ⑤ 토핑 추가 버튼 이벤트 연결 (최초 1회)
      setupToppingAddButton();

      // ⑥ 메뉴 관련 초기화 함수들
      setupToppingTags();
      setupExtraToppingButtons();
      setupMenuImageUpload(document);

      // ⑦ 서버에서 카테고리, 육수, 토핑 가져오기
      try {
        const [toppingsRes, categoriesRes, soupsRes] = await Promise.all([
          fetch('/ramen/toppings'),
          fetch('/ramen/categories'),
          fetch('/ramen/soups')
        ]);
        const toppings = await toppingsRes.json();
        const categories = await categoriesRes.json();
        const soups = await soupsRes.json();

        renderAllMenus(categories, soups, toppings);
        addExtraTopping(0); // 메뉴 인덱스 0으로 초기 렌더
        setupToppingTagEvents();
      } catch (error) {
        console.error("데이터 불러오기 실패:", error);
      }

      // ⑧ extra 토핑 선택 시 가격 입력 및 form hidden 추가
      document.querySelectorAll('.store-topping-btn').forEach(btn => {
        btn.addEventListener("click", function () {
          const id = btn.dataset.id;
          btn.classList.toggle("btn-success");
          btn.classList.toggle("btn-outline-secondary");

          const priceInput = document.querySelector(`.topping-price-input[data-id="${id}"]`);
          if (!priceInput) return;

          if (btn.classList.contains("btn-success")) {
            priceInput.style.display = "block";
            priceInput.required = true;
          } else {
            priceInput.style.display = "none";
            priceInput.value = "";
            priceInput.required = false;
          }
        });
      });

      // ⑨ submit 시 선택된 토핑들 form에 추가
      document.getElementById("register").addEventListener("submit", function () {
        const form = this;
        const selected = document.querySelectorAll(".store-topping-btn.btn-success");

        selected.forEach((btn, idx) => {
          const toppingId = btn.dataset.id;
          const priceInput = document.querySelector(`.topping-price-input[data-id="${toppingId}"]`);
          const price = priceInput ? priceInput.value : "";

          const idInput = document.createElement("input");
          idInput.type = "hidden";
          idInput.name = `extraToppings[${idx}].toppingId`;
          idInput.value = toppingId;

          const priceHidden = document.createElement("input");
          priceHidden.type = "hidden";
          priceHidden.name = `extraToppings[${idx}].price`;
          priceHidden.value = price;

          form.appendChild(idInput);
          form.appendChild(priceHidden);
        });
      });
    });

    // ------------------------
    // 🔧 함수들 (DOM 밖으로 빼놓은 부분)
    // ------------------------

    function updateMenuDescriptionCharCount(textarea, counterId) {
      const counter = document.getElementById(counterId);
      if (!textarea || !counter) return;

      counter.textContent = `${textarea.value.length} / 100자`;

      textarea.addEventListener('input', () => {
        counter.textContent = `${textarea.value.length} / 100자`;
      });
    }

    // ✅ 토핑 추가 버튼 이벤트 연결 함수
    function setupToppingAddButton() {
      const container = document.getElementById("store-extra-toppings-container");
      const addButtons = document.querySelectorAll(".add-topping-btn");

      addButtons.forEach(button => {
        const newButton = button.cloneNode(true);
        button.replaceWith(newButton);

        newButton.addEventListener("click", function () {
          const select = document.getElementById("topping-select");
          const priceInput = document.getElementById("topping-price");

          if (!select || !priceInput) {
            alert("토핑 선택 영역이 없습니다.");
            return;
          }

          const toppingId = select.value;
          const toppingName = select.options[select.selectedIndex].text;
          const price = priceInput.value;

          if (!toppingId || !price) {
            alert("토핑과 가격을 모두 입력해주세요.");
            return;
          }

          const exists = container.querySelector(`input[name="extraToppings[].toppingId"][value="${toppingId}"]`);
          if (exists) {
            alert("이미 추가된 토핑입니다.");
            return;
          }

          const div = document.createElement("div");
          div.className = "d-flex align-items-center gap-3";
          div.innerHTML = `
          <span>${toppingName} (${price}원)</span>
          <input type="hidden" name="extraToppings[].toppingId" value="${toppingId}"/>
          <input type="hidden" name="extraToppings[].price" value="${price}"/>
          <button type="button" class="btn btn-sm btn-outline-danger remove-topping">삭제</button>
        `;

          div.querySelector(".remove-topping").addEventListener("click", () => {
            div.remove();
          });

          container.appendChild(div);
          priceInput.value = "";
        });
      });
    }
  </script>

  <script>
    // 카테고리, 육수, 토핑 관련
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const [toppingsRes, categoriesRes, soupsRes] = await Promise.all([
          fetch('/ramen/toppings'),
          fetch('/ramen/categories'),
          fetch('/ramen/soups')
        ]);

        const toppings = await toppingsRes.json();
        const categories = await categoriesRes.json();
        const soups = await soupsRes.json();

        renderAllMenus(categories, soups, toppings);
        addExtraTopping(menuIndex);
        setupToppingTagEvents();

      } catch (error) {
        console.error("데이터 불러오기 실패:", error);
      }
    });

    function setupExtraToppingButtons(context = document) {
      context.querySelectorAll('.add-extra-topping').forEach(button => {
        button.onclick = () => {
          const menuItem = button.closest('.menu-item');
          const menus = Array.from(document.querySelectorAll('.menu-item'));
          const menuIndex = menus.indexOf(menuItem);
          addExtraTopping(menuIndex);
        };
      });
    }

    function addExtraTopping(menuIndex) {
      const menuItems = document.querySelectorAll('.menu-item');
      const menuItem = menuItems[menuIndex];
      if (!menuItem) return;

      const container = menuItem.querySelector('.extra-topping-container');
      if (!container) return;

      const inputWrapper = document.createElement('div');
      inputWrapper.className = 'input-group mb-2';

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control';
      input.name = `menus[${menuIndex}].extraToppings[]`;
      input.placeholder = '추가 토핑 입력';

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-outline-danger';
      removeBtn.textContent = '삭제';
      removeBtn.onclick = () => inputWrapper.remove();

      inputWrapper.appendChild(input);
      inputWrapper.appendChild(removeBtn);
      container.appendChild(inputWrapper);
    }


    // 여러 메뉴에 옵션/토핑 렌더링
    function renderAllMenus(categories, soups, toppings) {
      document.querySelectorAll('.menu-item').forEach((menuEl, idx) => {
        renderCategoryOptions(categories, menuEl.querySelector('select[name$=".ramenCategoryId"]'));
        renderSoupOptions(soups, menuEl.querySelector('select[name$=".ramenSoupId"]'));
        renderToppingTags(toppings, menuEl.querySelector('.topping-tags'), idx);
      });
    }

    function renderCategoryOptions(categories, selectEl) {
      if (!selectEl) return;
      selectEl.innerHTML = '<option value="" disabled selected>카테고리 선택</option>';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.categoryName || cat.name;
        selectEl.appendChild(option);
      });
    }

    function renderSoupOptions(soups, selectEl) {
      if (!selectEl) return;
      selectEl.innerHTML = '<option value="" disabled selected>육수 선택</option>';
      soups.forEach(soup => {
        const option = document.createElement('option');
        option.value = soup.id;
        option.textContent = soup.soupName;
        selectEl.appendChild(option);
      });
    }

    function renderToppingTags(toppings, container, menuIndex) {
      if (!container) return;
      container.innerHTML = '';
      container.dataset.menuIndex = menuIndex;
      toppings.forEach(top => {
        const span = document.createElement('span');
        span.className = 'topping-tag';
        span.dataset.id = top.id;
        span.textContent = top.name;
        container.appendChild(span);
      });
      setupToppingTagEvents(container);
    }

    function setupToppingTagEvents(container) {
      const containers = container ? [container] : document.querySelectorAll('.topping-tags');
      containers.forEach(cont => {
        cont.querySelectorAll('.topping-tag').forEach(tag => {
          tag.onclick = () => tag.classList.toggle('selected');
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupToppingTags();
      setupExtraToppingButtons();
      setupMenuImageUpload(document);

      const addStoreExtraToppingBtn = document.getElementById('add-store-extra-topping');
      if (addStoreExtraToppingBtn) {
        addStoreExtraToppingBtn.addEventListener('click', addStoreExtraTopping);
      }

      const imageInputs = document.querySelectorAll('.menu-image-input');
      imageInputs.forEach(input => {
        input.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (file) {
            const uploadArea = input.closest('.menu-image-upload');
            const menuPreview = uploadArea.querySelector('.menu-preview-image');
            const uploadText = uploadArea.querySelector('p');

            menuPreview.src = URL.createObjectURL(file);
            menuPreview.style.display = 'block';
            uploadText.style.display = 'none';
          }
        });
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // 토핑 버튼 클릭 → price 입력 표시 toggle
      document.querySelectorAll(".store-topping-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const id = btn.dataset.id;
          btn.classList.toggle("btn-success");
          btn.classList.toggle("btn-outline-secondary");

          const priceInput = document.querySelector(`.topping-price-input[data-id="${id}"]`);
          if (btn.classList.contains("btn-success")) {
            priceInput.style.display = "block";
            priceInput.required = true;
          } else {
            priceInput.style.display = "none";
            priceInput.value = "";
            priceInput.required = false;
          }
        });
      });

      // submit 시 선택된 extra 토핑 + 가격 -> form에 hidden input으로 주입
      document.getElementById("register").addEventListener("submit", function (e) {
        const form = this;

        // 기존에 추가된 hidden input 제거 (중복 방지)
        form.querySelectorAll('input[name^="extraToppings"]').forEach(input => input.remove());

        const selected = document.querySelectorAll(".store-topping-btn.btn-success");

        selected.forEach((btn, idx) => {
          const toppingId = btn.dataset.id;
          const priceInput = document.querySelector(`.topping-price-input[data-id="${toppingId}"]`);
          if (!priceInput) return; // priceInput 없으면 무시

          const price = priceInput.value;

          const idInput = document.createElement("input");
          idInput.type = "hidden";
          idInput.name = `extraToppings[${idx}].toppingId`;
          idInput.value = toppingId;

          const priceHidden = document.createElement("input");
          priceHidden.type = "hidden";
          priceHidden.name = `extraToppings[${idx}].price`;
          priceHidden.value = price;

          form.appendChild(idInput);
          form.appendChild(priceHidden);
        });
      });
    });
  </script>

</body>
</html>