<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>매장 수정</title>

    <!-- CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/submit.css" rel="stylesheet">
    <link href="/css/store-regist.css" rel="stylesheet">

</head>

<body>

<form method="post" th:action="@{/store/update/{storeId}(storeId=${storeRequestDto.id})}" enctype="multipart/form-data"
      id="updateForm" th:object="${storeRequestDto}">
    <div class="card mb-4">
        <h2 class="form_title">가게 수정</h2>
        <div class="card-body">

            <!-- 대표 이미지 -->
            <label for="image-input" id="image-upload-area"
                   style="border: 2px dashed #ccc; padding: 40px 30px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center;">

                <!-- 초기 이미지 또는 텍스트 안내 -->
                <span id="upload-text" th:if="*{storeMainImageUrl == null or storeMainImageUrl.isEmpty()}">
					대표 이미지를 등록해주세요.
    			</span>

                <img id="preview-image"
                     th:unless="*{storeMainImageUrl == null or storeMainImageUrl.isEmpty()}"
                     th:src="*{storeMainImageUrl}"
                     alt="대표 이미지 미리보기"
                     style="max-width: 100%; margin-top: 10px;"/>
            </label>

            <!-- 이미지 인풋: 선택 시 미리보기 이미지 src 변경 -->
            <input type="file"
                   id="image-input"
                   name="storeMainImage"
                   accept="image/*"
                   style="opacity: 0; position: absolute; width: 0; height: 0;"
                   onchange="document.getElementById('preview-image').src = window.URL.createObjectURL(this.files[0]); document.getElementById('upload-text')?.remove()"/>


            <!-- 가게 정보 -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="storeName">가게명</label>
                    <input type="text" id="storeName" class="form-control" required th:field="*{storeName}"/>
                </div>
                <div class="col-md-6">
                    <label for="phone">전화번호</label>
                    <input type="text" id="phone" class="form-control" required th:field="*{phone}"/>
                </div>
            </div>

            <!-- 주소 -->
            <div class="address-group mb-3">
                <label for="address-api">주소</label>
                <div class="input-group">
                    <input type="text" id="address-api" class="form-control" placeholder="도로명 주소" readonly
                           th:field="*{address}"/>
                    <button type="button" class="btn btn-outline-secondary" id="searchAddressBtn">주소 검색</button>
                </div>
                <input type="text" class="form-control mt-2"
                       placeholder="상세 주소"
                       th:field="*{storeDetailInput}"
                       id="store_detail_input"/>
                <input type="hidden" id="storeLat" th:field="*{storeLat}"/>
                <input type="hidden" id="storeLng" th:field="*{storeLng}"/>
                <input type="hidden" id="storeLegalCode" th:field="*{storeLegalCode}"/>
            </div>

            <!-- 사업자등록번호 -->
            <div class="mb-3">
                <label for="bizNum">사업자등록번호</label>
                <input type="text" id="bizNum" class="form-control" required th:field="*{bizNum}" maxlength="10"/>
            </div>

            <!-- 편의 정보 -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="localCard" th:field="*{isLocalCard}">
                        <label class="form-check-label" for="localCard">지역화폐</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="childAllowed" th:field="*{isChildAllowed}">
                        <label class="form-check-label" for="childAllowed">유아 동반</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label me-3">주차</label>
                    <div class="form-check form-check-inline"
                         th:each="parkingOpt : ${T(noodlezip.store.status.ParkingType).values()}">
                        <input class="form-check-input" type="radio" th:id="|parking_${parkingOpt.name()}|"
                               th:value="${parkingOpt.name()}" th:field="*{hasParking}">
                        <label class="form-check-label" th:for="|parking_${parkingOpt.name()}|"
                               th:text="${parkingOpt.value}"></label>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">운영 상태</label>
                <div class="form-check form-check-inline"
                     th:each="opStatus : ${T(noodlezip.store.status.OperationStatus).values()}">
                    <input class="form-check-input" type="radio"
                           th:id="|operation_${opStatus.name()}|"
                           th:name="operationStatus"
                           th:value="${opStatus.name()}"
                           th:field="*{operationStatus}">
                    <label class="form-check-label"
                           th:for="|operation_${opStatus.name()}|"
                           th:text="${opStatus.value}">운영 상태</label>
                </div>
            </div>

            <!-- 사장님 한마디 -->
            <div class="mb-3">
                <label for="ownerComment">사장님 한마디</label>
                <textarea id="ownerComment" class="form-control" rows="3" th:field="*{ownerComment}"></textarea>
            </div>

            <hr>

            <!-- 메뉴 -->
            <h4 class="mb-3">메뉴</h4>
            <div id="menu-items">
                <div class="menu-item mb-4 p-3 border rounded" th:each="menu, iterStat : *{menus}">
                    <input type="hidden" th:name="|menus[${iterStat.index}].id|" th:value="${menu.id}"/>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="menu-image-upload-label">
                                <img th:src="${menu.menuImageUrl != null ? menu.menuImageUrl : '/img/menu-thumb-1.jpg'}"
                                     class="menu-preview-image" alt="메뉴 이미지"/>
                                <input type="hidden" th:name="|menus[${iterStat.index}].existingMenuImageUrl|"
                                       th:value="${menu.menuImageUrl}"/>
                                <input type="file" th:name="|menus[${iterStat.index}].menuImageFile|"
                                       class="menu-image-input" accept="image/*" style="display:none;"/>
                            </label>
                        </div>
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <input type="text" placeholder="메뉴명" class="form-control" required
                                           th:name="|menus[${iterStat.index}].menuName|" th:value="${menu.menuName}"/>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <input type="number" placeholder="가격" class="form-control" required
                                           th:name="|menus[${iterStat.index}].price|" th:value="${menu.price}"/>
                                </div>
                                <div class="col-md-12 mb-2">
                                    <textarea placeholder="메뉴 설명" class="form-control"
                                              th:name="|menus[${iterStat.index}].menuDescription|"
                                              th:text="${menu.menuDescription}"></textarea>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <select class="form-select" th:name="|menus[${iterStat.index}].ramenCategoryId|">
                                        <option value="">카테고리</option>
                                        <option th:each="cat : ${categories}" th:value="${cat.id}"
                                                th:text="${cat.categoryName}"
                                                th:selected="${cat.id == menu.ramenCategoryId}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <select class="form-select" th:name="|menus[${iterStat.index}].ramenSoupId|">
                                        <option value="">육수</option>
                                        <option th:each="soup : ${soups}" th:value="${soup.id}"
                                                th:text="${soup.soupName}"
                                                th:selected="${soup.id == menu.ramenSoupId}"></option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-2">
                                    <label class="form-label">기본 토핑</label>
                                    <div class="topping-tags">
                                        <span th:each="topping : ${toppings}" class="topping-tag"
                                              th:data-id="${topping.id}" th:text="${topping.name}"
                                              th:classappend="${#lists.contains(menu.defaultToppingIds, topping.id)} ? 'selected' : ''"></span>
                                    </div>
                                    <div class="default-toppings-container" style="display:none;">
                                        <th:block th:each="toppingId : ${menu.defaultToppingIds}">
                                            <input type="hidden" th:name="|menus[${iterStat.index}].defaultToppingIds|"
                                                   th:value="${toppingId}"/>
                                        </th:block>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-menu">삭제</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" id="add-menu" class="btn btn-outline-primary">+ 메뉴 추가</button>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg">수정 완료</button>
            </div>

        </div>
        <input type="hidden" id="storeId" th:value="${storeRequestDto.id}"/>
    </div>
</form>

<!-- Scripts -->
<script src="/js/common_scripts.min.js"></script>
<script src="/js/common_func.js"></script>
<script src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js"></script>

<script th:inline="javascript">
    const categories = /*[[${categories}]]*/ [];
    const soups = /*[[${soups}]]*/ [];
    const toppings = /*[[${toppings}]]*/ [];
    const storeRequestDto = /*[[${storeRequestDto}]]*/ {};

    document.addEventListener('DOMContentLoaded', () => {
		// 이벤트 리스너 초기화
		setupEventListeners();
		// 기존 메뉴의 토핑 태그 이벤트 설정
		document.querySelectorAll('.topping-tags').forEach(container => setupToppingTagEvents(container));

		// 폼 제출 이벤트
		document.getElementById('updateForm').addEventListener('submit', async (e) => {
			e.preventDefault();

			const formData = new FormData();

			// StoreRequestDto 데이터 수집
			const storeData = {
				id: storeRequestDto.id,
				storeName: document.getElementById('storeName').value,
				address: document.getElementById('address-api').value,
				phone: document.getElementById('phone').value,
				bizNum: document.getElementById('bizNum').value,
				isLocalCard: document.getElementById('localCard').checked,
				isChildAllowed: document.getElementById('childAllowed').checked,
				hasParking: (() => {
					const checkedParking = document.querySelector('input[name="hasParking"]:checked');
					if (!checkedParking) {
						alert('주차 옵션을 선택해주세요.');
						throw new Error('Parking option not selected'); // Stop submission
					}
					return checkedParking.value;
				})(),
				ownerComment: document.getElementById('ownerComment').value,
                operationStatus: document.querySelector('input[name="operationStatus"]:checked')?.value || null,
                storeLat: document.getElementById('storeLat').value,
				storeLng: document.getElementById('storeLng').value,
				storeLegalCode: document.getElementById('storeLegalCode').value,
				storeDetailInput: document.getElementById('store_detail_input').value,
                menus: [],
				weekSchedule: []
			};

			// 메뉴 데이터 수집
			document.querySelectorAll('#menu-items .menu-item').forEach((menuEl, index) => {
				const menuId = menuEl.querySelector('input[name$=".id"]').value;
				const menuName = menuEl.querySelector('input[name$=".menuName"]').value;
				const price = menuEl.querySelector('input[name$=".price"]').value;
				const menuDescription = menuEl.querySelector('textarea[name$=".menuDescription"]').value;
				const ramenCategoryId = menuEl.querySelector('select[name$=".ramenCategoryId"]').value;
				const ramenSoupId = menuEl.querySelector('select[name$=".ramenSoupId"]').value;
				const defaultToppingIds = Array.from(menuEl.querySelectorAll('.default-toppings-container input[type="hidden"]')).map(input => input.value);

				storeData.menus.push({
					id: menuId,
					menuName: menuName,
					price: price,
					menuDescription: menuDescription,
					ramenCategoryId: ramenCategoryId,
					ramenSoupId: ramenSoupId,
					defaultToppingIds: defaultToppingIds
				});

					// 메뉴 이미지 파일 추가
					const menuImageFile = menuEl.querySelector('input[name$=".menuImageFile"]').files[0];
					const existingMenuImageUrl = menuEl.querySelector('input[name$=".existingMenuImageUrl"]')?.value;

					if (menuImageFile) {
						formData.append('menuImageFiles', menuImageFile);
					}
					// 빈 파일은 아예 안 보내기
					storeData.menus[index].menuImageUrl = existingMenuImageUrl;
				});

				// 대표 이미지 파일 추가
				const storeMainImageFile = document.getElementById('image-input').files[0];
				if (storeMainImageFile) {
					formData.append('storeMainImage', storeMainImageFile);
				} else {
					// 기존 이미지 URL 전송 (서버에서 기존 이미지 유지용)
					const existingStoreImageUrl = document.querySelector('#preview-image')?.src || '';
					formData.append('existingStoreMainImageUrl', existingStoreImageUrl);
				}
				const existingStoreImageUrl = document.querySelector('#preview-image')?.getAttribute('th:src') || '';
				storeData.storeMainImageUrl = storeMainImageFile ? '' : existingStoreImageUrl;


				// 7-1. 대표 이미지 첨부
				const storeMainImageInput = document.querySelector('input[name="storeMainImage"]');
				formData.append("storeMainImage", storeMainImageInput.files[0]);

				// 7-2. 메뉴 이미지 첨부 (여러 개)
				const menuImageInputs = document.querySelectorAll('.menu-image-input');
				menuImageInputs.forEach(input => {
					if (input.files && input.files[0]) {
						formData.append("menuImageFiles", input.files[0]);
					}
				});


				const storeBlob = new Blob([JSON.stringify(storeData)], {
					type: "application/json;charset=utf-8"
				});
				formData.append("dto", storeBlob);


				// AJAX 요청
				try {
					const response = await fetch(`/store/update/${storeRequestDto.id}`, {
						method: 'POST',
						body: formData
					});

					if (response.ok) {
						const result = await response.json();
						alert('매장 정보가 성공적으로 수정되었습니다.');
						window.location.href = `/store/detail/${storeRequestDto.id}`;
					} else {
						const errorText = await response.text();
						alert('매장 정보 수정 실패: ' + errorText);
					}
				} catch (error) {
					console.error('Error:', error);
					alert('서버 요청 중 오류가 발생했습니다.');
				}
			});
		});

		function setupEventListeners() {
			// 대표 이미지 업로드
			const imageInput = document.getElementById('image-input');
			const previewImage = document.getElementById('preview-image');
			const uploadText = document.getElementById('upload-text');
			// document.getElementById('image-upload-area').addEventListener('click', () => imageInput.click()); // Removed redundant listener
			imageInput.addEventListener('change', (event) => {
				const file = event.target.files[0];
				if (file) {
					const reader = new FileReader();
					reader.onload = (e) => {
						previewImage.src = e.target.result;
						previewImage.style.display = 'block';
						if (uploadText) uploadText.style.display = 'none';
					}
					reader.readAsDataURL(file);
				}
			});

			// 주소 검색
			document.getElementById('searchAddressBtn').addEventListener('click', () => {
				new daum.Postcode({
					oncomplete: function (data) {
						document.getElementById('address-api').value = data.roadAddress;
					}
				}).open();
			});

			// 메뉴 추가
			document.getElementById('add-menu').addEventListener('click', addMenu);

            // 메뉴 관련 이벤트 위임
            const menuItemsContainer = document.getElementById('menu-items');
            menuItemsContainer.addEventListener('click', (e) => {
                const target = e.target;

                // 메뉴 삭제
                if (target.classList.contains('remove-menu')) {
                    // 삭제 로직 생략
                }

                // 메뉴 이미지 클릭 시 input[type=file] 열기
                if (target.classList.contains('menu-preview-image')) {
                    const fileInput = target.closest('.menu-image-upload-label')?.querySelector('.menu-image-input');
                    if (fileInput) fileInput.click();
                }
            });


            menuItemsContainer.addEventListener('change', (e) => {
				// 메뉴 이미지 변경
				if (e.target.classList.contains('menu-image-input')) {
					const file = e.target.files[0];
					if (file) {
						const preview = e.target.closest('.menu-image-upload-label').querySelector('.menu-preview-image');
						const reader = new FileReader();
						reader.onload = (re) => {
							preview.src = re.target.result;
						};
						reader.readAsDataURL(file);
					}
				}
			});
		}

		function addMenu() {
			const menuContainer = document.getElementById('menu-items');
			const index = menuContainer.children.length;
			const newItem = document.createElement('div');
			newItem.className = 'menu-item mb-4 p-3 border rounded';
			newItem.innerHTML = `
            <input type="hidden" name="menus[${index}].id" value="0" />
            <div class="row">
                <div class="col-md-4">
                    <label class="menu-image-upload-label">
                        <img src="" class="menu-preview-image" alt="메뉴 이미지"/>
                        <input type="hidden" name="menus[${index}].existingMenuImageUrl" value="" />
                        <input type="file" name="menus[${index}].menuImageFile" class="menu-image-input" accept="image/*" style="display:none;"/>
                    </label>
                </div>
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6 mb-2"><input type="text" placeholder="메뉴명" class="form-control" required name="menus[${index}].menuName" /></div>
                        <div class="col-md-6 mb-2"><input type="number" placeholder="가격" class="form-control" required name="menus[${index}].price" /></div>
                        <div class="col-md-12 mb-2"><textarea placeholder="메뉴 설명" class="form-control" name="menus[${index}].menuDescription"></textarea></div>
                        <div class="col-md-6 mb-2">
                            <select class="form-select" name="menus[${index}].ramenCategoryId">
                                <option value="">카테고리</option>
                                ${categories.map(cat => `<option value="${cat.id}">${cat.categoryName}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <select class="form-select" name="menus[${index}].ramenSoupId">
                                <option value="">육수</option>
                                ${soups.map(soup => `<option value="${soup.id}">${soup.soupName}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-12 mb-2">
                            <label class="form-label">기본 토핑</label>
                            <div class="topping-tags">
                                ${toppings.map(t => `<span class="topping-tag" data-id="${t.id}">${t.name}</span>`).join('')}
                            </div>
                            <div class="default-toppings-container" style="display:none;"></div>
                        </div>
                    </div>
                    <div class="text-end"><button type="button" class="btn btn-sm btn-outline-danger remove-menu">삭제</button></div>
                </div>
            </div>
        `;
			menuContainer.appendChild(newItem);
			setupToppingTagEvents(newItem.querySelector('.topping-tags'));
			setupMenuImageEvents(newItem);
		}

		function setupToppingTagEvents(container) {
			container.querySelectorAll('.topping-tag').forEach(tag => {
				tag.addEventListener('click', () => {
					tag.classList.toggle('selected');
					const menuItem = tag.closest('.menu-item');
					const menuIndex = Array.from(menuItem.parentElement.children).indexOf(menuItem);
					const toppingId = tag.dataset.id;
					const hiddenContainer = menuItem.querySelector('.default-toppings-container');
					const existingInput = hiddenContainer.querySelector(`input[value="${toppingId}"]`);

					if (tag.classList.contains('selected')) {
						if (!existingInput) {
							const input = document.createElement('input');
							input.type = 'hidden';
							input.name = `menus[${menuIndex}].defaultToppingIds`;
							input.value = toppingId;
							hiddenContainer.appendChild(input);
						}
					} else {
						if (existingInput) {
							existingInput.remove();
						}
					}
				});
			});
		}

		function updateMenuIndices() {
			const menuItems = document.getElementById('menu-items').children;
			for (let i = 0; i < menuItems.length; i++) {
				const inputs = menuItems[i].querySelectorAll('[name^="menus["]');
				inputs.forEach(input => {
					const name = input.name.replace(/menus\[\d+\]/, `menus[${i}]`);
					input.name = name;
				});
			}
		}

		function setupMenuImageEvents(menuItem) {
			const input = menuItem.querySelector('.menu-image-input');
			const preview = menuItem.querySelector('.menu-preview-image');

			input.addEventListener('change', (event) => {
				const file = event.target.files[0];
				if (file) {
					const reader = new FileReader();
					reader.onload = (e) => {
						preview.src = e.target.result;
					};
					reader.readAsDataURL(file);
				}
			});
		}
</script>

</body>
</html>
