<!DOCTYPE html>
<html lang="en"
			xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{store/head :: head}"></head>



<body>
	<!-- header -->
	<th:block th:replace="~{store/header :: header}"></th:block>

	<main>
		
		<div class="container margin_detail">
		    <div class="row">
		        <div class="col-lg-8">
		            <div class="detail_page_head clearfix">
		                <div class="breadcrumbs">
		                    <ul>
		                        <li><a href="#">Home</a></li>
		                        <li><a href="#">Category</a></li>
		                        <li>Page active</li>
		                    </ul>
		                </div>
		                <div class="title">
		                    <h1 th:text="${store.storeName}">매장명</h1>
											<span th:text="${store.address}">주소</span>
											<a th:href="'https://map.naver.com/v5/search/' + ${store.storeName} + '?c=' + ${store.storeLng} + ',' + ${store.storeLat} + ',16,0,0'"
												 target="_blank">
												네이버 지도로 길찾기
											</a>
		                    <ul class="tags">
		                        <li><a href="#0">Pizza</a></li>
		                        <li><a href="#0">Italian Food</a></li>
		                        <li><a href="#0">Best Price</a></li>
		                    </ul>
		                </div>
									<!-- 이거 뭘로 바꾸지 -->
		                <div class="rating">
		                    <div class="score"><span>Superb<em>350 Reviews</em></span><strong>8.9</strong></div>
		                </div>
		            </div>
		            <!-- /detail_page_head -->

		            <div class="owl-carousel owl-theme carousel_1 magnific-gallery">
		                <div class="item">
		                    <a th:href="${store.storeMainImageUrl}" title="매장사진" data-effect="mfp-zoom-in">
													<img th:src="@{|${store.storeMainImageUrl} ?: '/img/detail_1.jpg'|}"
															 alt="store image"
															 onerror="this.onerror=null;this.src='/img/detail_1.jpg';">
												</a>
		                </div>
		            </div>
		            <!-- /carousel -->

		            <div class="tabs_detail">
		                <ul class="nav nav-tabs" role="tablist">
		                    <li class="nav-item">
		                        <a id="tab-A" href="#pane-A" class="nav-link active" data-bs-toggle="tab" role="tab">Information</a>
		                    </li>
												<li class="nav-item">
													<a id="tab-C" href="#pane-C" class="nav-link" data-bs-toggle="tab" role="tab">Menus</a>
												</li>
		                    <li class="nav-item">
		                        <a id="tab-B" href="#pane-B" class="nav-link" data-bs-toggle="tab" role="tab">Reviews</a>
		                    </li>
		                </ul>

		                <div class="tab-content" role="tablist">
		                    <div id="pane-A" class="card tab-pane fade show active" role="tabpanel" aria-labelledby="tab-A">
													<div th:replace="~{/store/fragments/tab-basic-info :: basic-info-tab}"></div>
		                    </div>
		                    <!-- /tab -->
											<input type="hidden" id="store-id" th:value="${store.id}">
											<div class="tab-pane fade" id="pane-C" role="tabpanel" aria-labelledby="tab-C"></div>
											<!-- tab-menu fragment -->

											<div class="tab-pane fade" id="pane-B" role="tabpanel" aria-labelledby="tab-B"></div>
											<!-- tab-review fragment-->

										</div>
									<!-- /tab-content -->
		            </div>
		            <!-- /tabs_detail -->
		        </div>
		        <!-- /col -->

		        <div class="col-lg-4" id="sidebar_fixed">
		            <div class="box_booking">
		                <div class="head">
		                    <h3>Book your table</h3>
		                    <div class="offer">Up to -40% off</div>
		                </div>
		                <!-- /head -->
		                <div class="main">
		                    <input type="text" id="datepicker_field">
		                    <div id="DatePicker"></div>
		                    <div class="dropdown time">
		                        <a href="#" data-bs-toggle="dropdown">Hour <span id="selected_time"></span></a>
		                        <div class="dropdown-menu">
		                            <div class="dropdown-menu-content">
		                                <h4>Lunch</h4>
		                                <div class="radio_select add_bottom_15">
		                                    <ul>
		                                        <li>
		                                            <input type="radio" id="time_1" name="time" value="12.00am">
		                                            <label for="time_1">12.00<em>-40%</em></label>
		                                        </li>
		                                        <li>
		                                            <input type="radio" id="time_2" name="time" value="08.30pm">
		                                            <label for="time_2">12.30<em>-40%</em></label>
		                                        </li>
		                                        <li>
		                                            <input type="radio" id="time_3" name="time" value="09.00pm">
		                                            <label for="time_3">1.00<em>-40%</em></label>
		                                        </li>
		                                        <li>
		                                            <input type="radio" id="time_4" name="time" value="09.30pm">
		                                            <label for="time_4">1.30<em>-40%</em></label>
		                                        </li>
		                                    </ul>
		                                </div>
		                                <!-- /time_select -->
		                                <h4>Dinner</h4>
		                                <div class="radio_select">
		                                    <ul>
		                                        <li>
		                                            <input type="radio" id="time_5" name="time" value="08.00pm">
		                                            <label for="time_1">20.00<em>-40%</em></label>
		                                        </li>
		                                        <li>
		                                            <input type="radio" id="time_6" name="time" value="08.30pm">
		                                            <label for="time_2">20.30<em>-40%</em></label>
		                                        </li>
		                                        <li>
		                                            <input type="radio" id="time_7" name="time" value="09.00pm">
		                                            <label for="time_3">21.00<em>-40%</em></label>
		                                        </li>
		                                        <li>
		                                            <input type="radio" id="time_8" name="time" value="09.30pm">
		                                            <label for="time_4">21.30<em>-40%</em></label>
		                                        </li>
		                                    </ul>
		                                </div>
		                                <!-- /time_select -->
		                            </div>
		                        </div>
		                    </div>
		                    <!-- /dropdown -->
		                    <div class="dropdown people">
		                        <a href="#" data-bs-toggle="dropdown">People <span id="selected_people"></span></a>
		                        <div class="dropdown-menu">
		                            <div class="dropdown-menu-content">
		                                <h4>How many people?</h4>
		                                <div class="radio_select">
		                                    <ul>
		                                        <li>
		                                            <input type="radio" id="people_1" name="people" value="1">
		                                            <label for="people_1">1<em>-40%</em></label>
		                                        </li>
		                                        <li>
		                                            <input type="radio" id="people_2" name="people" value="2">
		                                            <label for="people_2">2<em>-40%</em></label>
		                                        </li>
		                                        <li>
		                                            <input type="radio" id="people_3" name="people" value="3">
		                                            <label for="people_3">3<em>-40%</em></label>
		                                        </li>
		                                        <li>
		                                            <input type="radio" id="people_4" name="people" value="4">
		                                            <label for="people_4">4<em>-40%</em></label>
		                                        </li>
		                                    </ul>
		                                </div>
		                                <!-- /people_select -->
		                            </div>
		                        </div>
		                    </div>
		                    <!-- /dropdown -->
		                    <a href="#0" class="btn_1 full-width mb_5">Reserve Now</a>
		                    <a href="wishlist.html" class="btn_1 full-width outline wishlist"><i class="icon_heart"></i> Add to wishlist</a>
		                </div>
		            </div>
		            <!-- /box_booking -->
		            <ul class="share-buttons">
		                <li><a class="fb-share" href="#0"><i class="social_facebook"></i> Share</a></li>
		                <li><a class="twitter-share" href="#0"><i class="social_twitter"></i> Share</a></li>
		                <li><a class="gplus-share" href="#0"><i class="social_googleplus"></i> Share</a></li>
		            </ul>
		        </div>

		    </div>
		    <!-- /row -->
		</div>
		<!-- /container -->
		
	</main>
	<!-- /main -->

	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const tabC = document.getElementById("tab-C");
			const paneC = document.getElementById("pane-C");
			const storeId = document.getElementById("store-id").value; // storeId를 숨겨놓고 가져옴

			let menuLoaded = false; // 중복 요청 방지

			tabC.addEventListener("click", () => {
				if (menuLoaded) return; // 이미 로드된 경우는 생략
				fetch(`/store/detail/${storeId}/menuList`)
					.then(response => {
						if (!response.ok) throw new Error("Menu tab load failed");
						return response.text();
					})
					.then(html => {
						paneC.innerHTML = html;
						initMenuFilter();
						menuLoaded = true;
					})
					.catch(err => {
						console.error(err);
					});
			});

			function initMenuFilter() {
				const tagEls = paneC.querySelectorAll(".filter-tag");
				const menuEls = paneC.querySelectorAll(".menu_card");

				if (tagEls.length === 0 || menuEls.length === 0) return;

				const activeFilters = {
					category: new Set(),
					soup: new Set(),
					topping: new Set()
				};

				tagEls.forEach(tag => {
					const type = tag.dataset.type;
					const value = tag.dataset.value;
					activeFilters[type].add(value);
				});

				tagEls.forEach(tag => {
					tag.addEventListener("click", () => {
						const type = tag.dataset.type;
						const value = tag.dataset.value;

						tag.classList.toggle("inactive");

						if (activeFilters[type].has(value)) {
							activeFilters[type].delete(value);
						} else {
							activeFilters[type].add(value);
						}

						filterMenus();
					});
				});

				function filterMenus() {
					menuEls.forEach(menu => {
						const category = menu.dataset.category;
						const soup = menu.dataset.soup;
						const toppings = (menu.dataset.toppings || "").split(",");

						const categoryMatch = activeFilters.category.size === 0 || activeFilters.category.has(category);
						const soupMatch = activeFilters.soup.size === 0 || activeFilters.soup.has(soup);
						const toppingMatch = activeFilters.topping.size === 0 || toppings.some(t => activeFilters.topping.has(t.trim()));

						if (categoryMatch && soupMatch && toppingMatch) {
							menu.style.display = "";
						} else {
							menu.style.display = "none";
						}
					});
				}
			}
		});
	</script>
	<!-- menu-tab 실행 -->


	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const tabB = document.getElementById("tab-B");
			const paneB = document.getElementById("pane-B");
			const storeId = document.getElementById("store-id").value;

			let reviewLoaded = false;

			tabB.addEventListener("click", () => {
				if (reviewLoaded) return;
				fetch(`/store/detail/${storeId}/reviews?page=1`)
					.then(res => res.text())
					.then(html => {
						paneB.innerHTML = html;
						initLoadMore();
						reviewLoaded = true;
					})
					.catch(err => console.error("리뷰 탭 로딩 실패", err));
			});

			function initLoadMore() {
				const container = document.getElementById("reviews");
				const loadMoreWrapper = document.getElementById("load-more-review-wrapper");
				if (!loadMoreWrapper) return;

				loadMoreWrapper.addEventListener("click", (e) => {
					const btn = e.target.closest("#load-more-review-btn");
					if (!btn) return;

					const nextPage = btn.dataset.nextPage;

					fetch(`/store/detail/${storeId}/reviews?page=${nextPage}`)
						.then(res => res.text())
						.then(html => {
							const tempDiv = document.createElement("div");
							tempDiv.innerHTML = html;

							const newCards = tempDiv.querySelectorAll(".review_card");
							const newWrapper = tempDiv.querySelector("#load-more-review-wrapper");

							newCards.forEach(card => container.appendChild(card));
							loadMoreWrapper.remove(); // 기존 버튼 제거
							if (newWrapper) container.after(newWrapper); // 새 버튼 삽입

						})
						.catch(err => console.error("더보기 실패", err));
				});
			}
		});
	</script>
<!--	<script th:src="@{/js/store_review_tab.js}"></script>-->
	<!-- review 탭 설정 script -->


	<!-- footer -->
	<th:block th:replace="~{fragments/footer :: footer}"></th:block>

	<div id="toTop"></div><!-- Back to top button -->
	
	<div class="layer"></div><!-- Opacity Mask Menu Mobile -->
	
	<!-- Sign In Modal -->
	<th:block th:replace="~{store/signin-modal :: signin-modal}"></th:block>

	<!-- COMMON SCRIPTS -->
    <script src="/js/common_scripts.min.js"></script>
    <script src="/js/common_func.js"></script>
    <script src="/assets/validate.js"></script>
    
    <!-- SPECIFIC SCRIPTS -->
    <script src="/js/sticky_sidebar.min.js"></script>
    <script src="/js/specific_detail.js"></script>
	<script src="/js/datepicker.min.js"></script>
	<script src="/js/datepicker_func_1.js"></script>

</body>
</html>