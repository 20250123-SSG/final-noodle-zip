<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Foogra - Discover & Book the best restaurants at the best price">
	<meta name="author" content="Ansonika">
	<title>Foogra - Discover & Book the best restaurants at the best price</title>

	<!-- Favicons-->
	<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" type="image/x-icon" href="img/apple-touch-icon-57x57-precomposed.png">
	<link rel="apple-touch-icon" type="image/x-icon" sizes="72x72" href="img/apple-touch-icon-72x72-precomposed.png">
	<link rel="apple-touch-icon" type="image/x-icon" sizes="114x114" href="img/apple-touch-icon-114x114-precomposed.png">
	<link rel="apple-touch-icon" type="image/x-icon" sizes="144x144" href="img/apple-touch-icon-144x144-precomposed.png">

	<!-- GOOGLE WEB FONT -->
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

	<!-- BASE CSS -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/style.css" rel="stylesheet">

	<!-- SPECIFIC CSS -->
	<link href="/css/review.css" rel="stylesheet">

	<!-- YOUR CUSTOM CSS -->
	<link href="/css/custom.css" rel="stylesheet">
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />

	<style>
		.review-slider {
			margin-top: 30px;
		}
		.slick-item {
			padding: 10px;
			outline: none;
		}
		.slick-item .card {
			border: 1px solid #ddd;
			border-radius: 10px;
			padding: 20px;
			height: 100%;
		}
		.slick-prev:before,
		.slick-next:before {
			color: #333;
		}
	</style>

	<script th:inline="javascript">
		let toppings = /*[[${toppings}]]*/ [];
		console.log("🍜 토핑:", toppings);
	</script>

</head>
<body>
<!-- ... header 및 상단 생략 ... -->
<main class="bg_gray pattern">
	<div class="container margin_60_40">
		<div class="row justify-content-center">
			<div class="col-lg-8">
				<div class="box_general write_review">
					<h2 th:text="|${storeName}에 리뷰를 남겨주세요!|"></h2>
					<div id="menu-selection">
						<h3>리뷰를 남길 메뉴를 선택해주세요</h3>
						<div class="form-group" th:each="menu : ${menuList}">
							<label>
								<input type="checkbox" class="menu-checkbox" th:value="${menu.menuId}" th:data-name="${menu.menuName}">
								<span th:text="${menu.menuName}"></span>
							</label>
						</div>
						<button id="startReviewBtn" class="btn btn-primary">리뷰 작성하기</button>
					</div>
					<form th:action="@{/review/submit}" method="post" enctype="multipart/form-data" style="display:none;" id="reviewForm">
						<div class="review-slider"></div>
						<div class="text-center" style="margin-top: 30px;">
							<button type="button" class="btn btn-sm btn-info" id="openMenuModal" data-toggle="modal" data-target="#menuSelectModal">+ 메뉴 추가</button>
							<button type="submit" class="btn btn-success">리뷰 제출</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</main>

<!-- 메뉴 선택 모달 -->
<div id="menuSelectModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="menuModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="menuModalLabel">메뉴 선택</h4>
			</div>
			<div class="modal-body">
				<ul id="menuListContainer"></ul>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>
<footer th:replace="~{fragments/footer :: footer}"></footer>
<div id="toTop"></div>
<div class="layer"></div>
<script src="/js/common_scripts.min.js"></script>
<script src="/js/common_func.js"></script>
<script src="/assets/validate.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script>


	const addedMenuIds = new Set();

	$('#startReviewBtn').on('click', function () {
		addedMenuIds.clear();

		const selectedMenus = $('.menu-checkbox:checked');
		if (selectedMenus.length === 0) {
			alert("리뷰할 메뉴를 1개 이상 선택해주세요.");
			return;
		}

		const slider = $('.review-slider');
		slider.empty();

		selectedMenus.each(function (index) {
			const menuId = $(this).val();
			const menuName = $(this).data('name');
			addedMenuIds.add(String(menuId));
			const html = getReviewSlideHtml(menuId, menuName, index);
			slider.append(html);
		});

		$('#menu-selection').hide();
		$('#reviewForm').show();
		$('#menuAddBtnContainer').show();

		slider.slick({
			slidesToShow: 1,
			centerMode: true,
			centerPadding: '60px',
			arrows: true,
			infinite: false
		});
	});

	$('#openMenuModal').on('click', function () {
		$('body').removeClass('modal-open');
		refreshMenuModalList();
		$('#menuSelectModal').modal('show');
	});

	let pendingMenuToAdd = null;

	$(document).on('click', '.addMenuBtn', function () {
		const menuId = String($(this).data('id'));
		const menuName = $(this).data('name');
		pendingMenuToAdd = { id: menuId, name: menuName };
		$('#menuSelectModal').modal('hide'); // 모달만 닫고, 추가는 나중에
	});

	// 모달이 완전히 닫힌 후 슬라이드 추가
	$('#menuSelectModal').on('hidden.bs.modal', function () {
		setTimeout(() => {
			$('body').removeClass('modal-open');
			$('.modal-backdrop').remove();
			$('#openMenuModal').blur();

			if (pendingMenuToAdd !== null) {
				const menuId = pendingMenuToAdd.id;
				const menuName = pendingMenuToAdd.name;
				const index = $('.review-slider .slick-item').length;
				const html = getReviewSlideHtml(menuId, menuName, index);
				$('.review-slider').slick('slickAdd', html);
				addedMenuIds.add(menuId);
				$('.menu-checkbox[value="' + menuId + '"]').prop('checked', true);
				refreshMenuModalList();
				pendingMenuToAdd = null;
			}
		}, 300);
	});


	$(document).on('click', '.remove-slide', function () {
		const $slide = $(this).closest('.slick-item');
		const index = $slide.attr('data-slick-index');
		const menuId = String($(this).data('menu-id'));

		const slideIndex = $slide.index();
		$('.review-slider').slick('slickRemove', slideIndex);
		addedMenuIds.delete(menuId);
		$('.menu-checkbox[value="' + menuId + '"]').prop('checked', false);
		refreshMenuModalList();
	});

	function refreshMenuModalList() {
		const $list = $('#menuListContainer');
		$list.empty();

		$('.menu-checkbox').each(function () {
			const id = String($(this).val());
			const name = $(this).data('name');
			if (!addedMenuIds.has(id)) {
				const item = `<li class="mb-2"><button type="button" class="btn btn-info addMenuBtn" data-id="${id}" data-name="${name}">${name}</button></li>`;
				$list.append(item);
			}
		});
	}

	function forceCloseModal() {
		$('#menuSelectModal').modal('hide');
		$('.modal-backdrop').remove();
		$('body').removeClass('modal-open');
		$('body').css('padding-right', '');
	}

	$('#menuSelectModal').on('hidden.bs.modal', function () {
		forceCloseModal();
		$('#openMenuModal').blur();
	});

	function getReviewSlideHtml(menuId, menuName, index) {
		let toppingOptions = '';
		toppings.forEach(topping => {
			toppingOptions += `
      <label class="checkbox-inline">
        <input type="checkbox" name="reviews[${index}].toppingIds" value="${topping.id}"> ${topping.name}
      </label>`;
		});

		return `
        <div class="slick-item" data-slick-index="${index}">
          <div class="card p-3">
            <h4>${menuName}에 대한 리뷰</h4>
            <input type="hidden" name="reviews[${index}].menuId" value="${menuId}" />
            <div class="row">
              <div class="col-xs-6"><label>면 굵기</label><input type="range" name="reviews[${index}].noodleThickness" min="0" max="10" value="5"/></div>
              <div class="col-xs-6"><label>면 식감</label><input type="range" name="reviews[${index}].noodleTexture" min="0" max="10" value="5"/></div>
              <div class="col-xs-6"><label>면 삶기</label><input type="range" name="reviews[${index}].noodleBoiledLevel" min="0" max="10" value="5"/></div>
              <div class="col-xs-6"><label>국물 농도</label><input type="range" name="reviews[${index}].soupThickness" min="0" max="10" value="5"/></div>
              <div class="col-xs-6"><label>온도</label><input type="range" name="reviews[${index}].soupTemperature" min="0" max="10" value="5"/></div>
              <div class="col-xs-6"><label>염도</label><input type="range" name="reviews[${index}].soupSaltiness" min="0" max="10" value="5"/></div>
              <div class="col-xs-6"><label>맵기</label><input type="range" name="reviews[${index}].soupSpiciness" min="0" max="10" value="5"/></div>
              <div class="col-xs-6"><label>기름</label><input type="range" name="reviews[${index}].soupOiliness" min="0" max="10" value="5"/></div>
            </div>
            <div class="form-group">
          <label>먹은 토핑 선택</label><br/>
          ${toppingOptions}
       		 </div>
            <div class="form-group">
              <label>제목</label>
              <input type="text" class="form-control" name="reviews[${index}].title" />
            </div>
            <div class="form-group">
              <label>내용</label>
              <textarea class="form-control" name="reviews[${index}].content" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label>사진 첨부</label>
              <input type="file" name="reviews[${index}].imageFile" accept="image/*" />
            </div>
            <button type="button" class="btn btn-danger remove-slide" data-menu-id="${menuId}">삭제</button>
          </div>
        </div>`;
	}
</script>
</body>
</html>
