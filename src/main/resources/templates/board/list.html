<!DOCTYPE html>
<html lang="ko">

<head>
    <th:block th:replace="~{fragments/head :: head}"></th:block>
    <!-- SPECIFIC CSS -->
    <link href="/css/blog.css" rel="stylesheet">
</head>

<body class="margin_sticky">

<div th:replace="~{fragments/subHeader :: subHeader}"></div>

<main>
    <div class="page_header element_to_stick">
        <div class="container">
            <div class="row">
                <div class="col-xl-8 col-lg-7 col-md-7 d-none d-md-block">
                    <div class="breadcrumbs blog">
                        <ul>
                            <li><a href="#">Home</a></li>
                            <li><a href="#">Category</a></li>
                            <li>Page active</li>
                        </ul>
                    </div>
                </div>
                <div class="col-xl-4 col-lg-5 col-md-5">
                    <div class="search_bar_list">
                        <input id="searchInput" type="text" class="form-control" placeholder="Search in blog...">
                        <input type="submit" value="Search" onclick="performSearch()">
                    </div>
                </div>
            </div>
            <!-- /row -->
        </div>
    </div>
    <!-- /page_header -->

    <div class="container margin_30_40">
        <div class="row">
            <div class="col-lg-9">
                <div class="row">
                    <div class="col-md-6" th:each="item : ${board}">
                        <article class="blog">
                            <figure>
                                <a th:href="@{/board/detail/{id}(id=${item.boardId})}">
                                    <img th:src="${#strings.isEmpty(item.imageUrl) ? '/img/blog-1.jpg' : item.imageUrl}"
                                         alt="게시글 이미지">
                                    <div class="preview"><span>더 보기</span></div>
                                </a>
                            </figure>
                            <div class="post_info">
                                <small>
                                    <span th:text="${item.communityType}">카테고리</span> -
                                    <span th:text="${#temporals.format(item.createdAt, 'yyyy.MM.dd')}">2023.01.01</span>
                                </small>
                                <h2><a th:href="@{/board/detail/{id}(id=${item.boardId})}" th:text="${item.title}">게시글
                                    제목</a>
                                </h2>
                                <!--                                <p th:utext="${#strings.abbreviate(item.content, 100)}">게시글 내용 요약...</p>-->
                                <ul>
                                    <li>
                                        <div class="thumb"><img
                                                th:src="${#strings.isEmpty(item.userProfileImageUrl) ? '/img/avatar.jpg' : item.userProfileImageUrl}"
                                                alt="작성자 프로필 이미지"></div>
                                        <span th:text="${item.userName}">작성자</span>
                                    </li>
                                    <li><i class="icon_heart"></i><span th:text="${item.likesCount}">0</span></li>
                                    <li><i class="icon_cursor"></i><span th:text="${item.viewsCount}">0</span></li>
                                </ul>
                            </div>
                        </article>
                        <!-- /article -->
                    </div>
                    <!-- /col -->
                </div>
                <!-- /row -->

                <div class="pagination_fg" th:if="${totalPage > 0}">
                    <a th:href="${category != null and #strings.length(category) > 0} ?
        ( ${searchKeyword != null and #strings.length(searchKeyword) > 0} ?
            @{/board/{category}/list(page=${page - 1}, category=${category}, search=${searchKeyword})} :
            @{/board/{category}/list(page=${page - 1}, category=${category})}
        ) :
        ( ${searchKeyword != null and #strings.length(searchKeyword) > 0} ?
            @{/board/list(page=${page - 1}, search=${searchKeyword})} :
            @{/board/list(page=${page - 1})}
        )"
                       th:if="${!isFirst}">&laquo;</a>

                    <th:block th:each="i : ${#numbers.sequence(beginPage, endPage)}">
                        <a th:href="${category != null and #strings.length(category) > 0} ?
            ( ${searchKeyword != null and #strings.length(searchKeyword) > 0} ?
                @{/board/{category}/list(page=${i}, category=${category}, search=${searchKeyword})} :
                @{/board/{category}/list(page=${i}, category=${category})}
            ) :
            ( ${searchKeyword != null and #strings.length(searchKeyword) > 0} ?
                @{/board/list(page=${i}, search=${searchKeyword})} :
                @{/board/list(page=${i})}
            )"
                           th:classappend="${i eq page} ? 'active' : ''">
                            <span th:text="${i}"></span>
                        </a>
                    </th:block>

                    <a th:href="${category != null and #strings.length(category) > 0} ?
        ( ${searchKeyword != null and #strings.length(searchKeyword) > 0} ?
            @{/board/{category}/list(page=${page + 1}, category=${category}, search=${searchKeyword})} :
            @{/board/{category}/list(page=${page + 1}, category=${category})}
        ) :
        ( ${searchKeyword != null and #strings.length(searchKeyword) > 0} ?
            @{/board/list(page=${page + 1}, search=${searchKeyword})} :
            @{/board/list(page=${page + 1})}
        )"
                       th:if="${!isLast}">&raquo;</a>
                </div>

            </div>
            <!-- /col -->

            <aside class="col-lg-3">
                <div class="widget">
                    <div class="widget-title first">
                        <h4>최근 본 게시글</h4>
                    </div>
                    <ul class="comments-list" id="recent-boards-list-container">
                        <li id="loading-message">로딩 중...</li>
                        <li id="no-boards-message" style="display:none;">최근 본 게시글이 없습니다.</li>
                    </ul>
                </div>
                <!-- /widget -->
                <div class="widget">
                    <div class="widget-title">
                        <h4>게시판</h4>
                    </div>
                    <ul class="cats">
                        <li><a th:href="@{/board/list}"><strong>전체 게시글 보기</strong></a></li>
                        <li th:each="categoryCount : ${categoryCounts}">
                            <a th:href="@{/board/{communityType}/list(communityType=${categoryCount.communityType})}"
                               th:text="${categoryCount.displayName} + '(' + ${categoryCount.count} + ')'">카테고리(0)
                            </a>
                        </li>
                    </ul>
                </div>
                <!-- /widget -->
                <div class="widget">
                    <div class="widget-title">
                        <h4>Popular Tags</h4>
                    </div>
                    <div class="tags">
                        <a th:each="tag : ${popularTags}" 
                           th:href="@{/board/review/list(tag=${tag.tagName}, type=${tag.tagType})}"
                           th:text="${tag.tagName}">태그</a>
                    </div>
                </div>
                <!-- /widget -->
            </aside>
            <!-- /aside -->
        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</main>
<!-- /main -->
<footer th:replace="~{fragments/footer :: footer}"></footer>
<!--/footer-->

<div id="toTop"></div><!-- Back to top button -->

<script>
    function initializeRecentBoardsWidget() {
        const listContainer = document.getElementById('recent-boards-list-container');
        const loadingMessage = document.getElementById('loading-message');
        const noBoardsMessage = document.getElementById('no-boards-message');
        if (!listContainer || !loadingMessage || !noBoardsMessage) {
            console.warn("Recent boards widget elements not found. Skipping initialization.");
            return; // 필수 DOM 요소가 없으면 함수 종료
        }

        // 이전에 추가된 게시글 목록 초기화
        listContainer.innerHTML = ''; // 기존 내용을 모두 지움
        listContainer.appendChild(loadingMessage); // 로딩 메시지 다시 삽입 (만약 HTML 구조상 제거되었다면)
        loadingMessage.style.display = 'block';
        noBoardsMessage.style.display = 'none';

        fetch('/board/recent')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(boards => {
                loadingMessage.style.display = 'none'; // 로딩 메시지 숨김
                if (boards.payload && boards.payload.length > 0) {
                    // 게시글 목록이 있을 경우, 각 게시글에 대해 li 요소를 생성하여 추가
                    boards.payload.forEach(board => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                        <div class="alignleft">
                            <a href="/board/detail/${board.id}">
                                <img src="${board.imageUrl ? board.imageUrl : '/img/blog-1.jpg'}" alt="게시글 이미지">
                            </a>
                        </div>
                        <small>
                            ${board.category ? board.category : 'General'} -
                            ${board.createdAt ? new Date(board.createdAt).toLocaleDateString('ko-KR') : 'N/A'}
                        </small>
                        <h3><a href="/board/detail/${board.id}" title="${board.title}">${board.title}</a></h3>
                    `;
                        listContainer.appendChild(li);
                    });
                } else {
                    noBoardsMessage.style.display = 'block';
                    listContainer.appendChild(noBoardsMessage);
                }
            })
            .catch(error => {
                loadingMessage.style.display = 'none'; // 로딩 메시지 숨김
                noBoardsMessage.style.display = 'block'; // 메시지 표시
                noBoardsMessage.textContent = '최근 본 게시글을 불러오는 데 실패했습니다.';
                listContainer.appendChild(noBoardsMessage);
                console.error('Error fetching recent boards:', error);
            });
    }

    function performSearch() {
        const searchInput = document.getElementById('searchInput');
        const keyword = searchInput.value.trim();

        if (keyword === "") {
            alert("검색어를 입력해주세요.");
            searchInput.focus();
            return;
        }

        const encodedKeyword = encodeURIComponent(keyword);

        // 현재 URL의 경로 부분을 가져옵니다. (예: /board/free/list)
        const currentPath = window.location.pathname;

        let targetUrl = "/board/list"; // 기본 검색 대상 URL (모든 게시글 검색 시)
        let communityType = null;

        // 정규 표현식을 사용하여 경로에서 communityType을 추출합니다.
        // 예: /board/free/list, /board/notice/list 등
        const pathMatch = currentPath.match(/\/board\/([a-zA-Z0-9]+)\/list/);

        if (pathMatch && pathMatch[1]) {
            // 정규 표현식에 매칭되면 두 번째 캡처 그룹([1])이 communityType입니다.
            communityType = pathMatch[1];
        }

        if (communityType) {
            targetUrl = `/board/${encodeURIComponent(communityType)}/list?search=${encodedKeyword}`;
        } else {
            targetUrl = `/board/list?search=${encodedKeyword}`;
        }

        location.href = targetUrl;
    }

    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            performSearch();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        initializeRecentBoardsWidget();
    });
</script>
<!-- COMMON SCRIPTS -->
<script src="/js/common_scripts.min.js"></script>
<script src="/js/common_func.js"></script>
<script src="/assets/validate.js"></script>

</body>
</html>