<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <th:block th:replace="~{fragments/head :: head}"></th:block>
  <!-- SPECIFIC CSS -->
  <link href="/css/listing.css" rel="stylesheet">
  <link href="/css/search-custom.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

  <style>

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    /* 전체 배경 */
    body {
      background-color: #f5f5f5;
    }

    main {
      min-height: calc(100vh - 150px);
      padding-top: 100px;
      padding-bottom: 120px;
      box-sizing: border-box;
    }

    /* 메인 컨테이너: 너비 줄임 */
    .container {
      max-width: 380px;
      margin: 0 auto;
      padding: 0 15px;
    }


    /* 카드 스타일 */
    .ocr-card {
      background: #fff;
      padding: 25px 20px;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
      max-width: 580px;
      margin: 0 auto;
    }

    .preview-wrapper {
      position: relative;
      max-width: 100%;
      margin-top: 10px;
      min-height: 280px;         /* ✅ 이미지 공간 확보 */
      background-color: #fafafa;
      border: 1px dashed #ccc;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .placeholder-box {
      text-align: center;
      color: #888;
      font-size: 14px;
    }

    #preview {
      display: none;
      max-width: 100%;
      max-height: 500px;
      object-fit: contain;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 0 auto;
    }

    /* 스캔 필터 */
    #scan-filter {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 255, 0, 0.08);
      pointer-events: none;
      display: none;
      z-index: 1;
    }

    /* 스캔 라인 */
    #scan-line {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 5px;
      background: rgba(0, 255, 0, 0.35);
      display: none;
      z-index: 2;
      animation: scanMove 2s linear infinite alternate;
    }

    /* 스캔 애니메이션 */
    @keyframes scanMove {
      0%   { top: 0; }
      100% { top: 100%; }
    }

    /* 고정 버튼 내부 스타일 */
    .fixed-action-buttons .btn {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 20px;   /* ✅ pill 모양 */
      margin-left: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>

<body class="margin_sticky">
<!-- header -->
<div th:replace="~{fragments/subHeader :: subHeader}"></div>

<!-- 리뷰 작성 버튼 -->
<!--<button type="button" class="btn btn-primary" onclick="checkLoginBeforeUpload()">-->
<!--  리뷰 작성하기-->
<!--</button>-->

<main>
  <div class="container">
    <div class="ocr-card">

      <!-- OCR Form -->
      <form id="ocrForm" enctype="multipart/form-data">
        <input type="file" id="file" name="file" accept="image/*" class="form-control mb-3" required>

        <div class="preview-wrapper" id="previewWrapper">
          <img id="preview" src="#" alt="미리보기" style="display: none;">
          <div id="scan-filter"></div>
          <div id="scan-line"></div>
          <div id="previewPlaceholder" class="placeholder-box">
            <p>여기에 영수증 이미지가 표시됩니다</p>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block mt-3">분석하기</button>
      </form>

      <!-- OCR 결과 -->
      <div id="ocrResultBox" style="display:none;" class="mt-4">
        <h4 class="mb-3">OCR 결과 확인</h4>
        <p><strong>매장명:</strong> <span id="storeName"></span></p>
        <p><strong>방문일:</strong> <span id="date"></span></p>
        <p><strong>주문메뉴:</strong> <span id="menuNames"></span></p>

        <form id="proceedForm" method="POST" action="/board/review">
          <input type="hidden" name="bizNum" />
          <input type="hidden" name="ocrKeyHash" />
          <input type="hidden" name="visitDate" />
          <input type="hidden" name="isReceiptReview" value="true" />
          <div id="ocrActionButtons" class="mt-4" style="text-align: right;">
            <button type="button" class="btn btn-success btn-sm" onclick="proceedToReview()">✔ 맞아요! 리뷰 작성</button>
            <!-- <button type="button" class="btn btn-secondary btn-sm" disabled>✖ 아니요! 수정할래요</button> -->
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<footer th:replace="~{fragments/footer :: footer}"></footer>


<!-- ───────────────────── 스크립트 ───────────────────── -->
<script>
  // 로그인 확인
  function checkLoginBeforeUpload() {
    fetch("/auth/check")
      .then(res => {
        if (res.status === 401) {
          alert("로그인이 필요한 기능입니다.");
          return;
        }
        $('#ocrModal').modal('show');
      })
      .catch(err => {
        console.error("❌ 인증 확인 실패:", err);
        alert("시스템 오류가 발생했습니다.");
      });
  }

  // ① 파일 선택 → 미리보기 표시 및 OCR 결과 영역 초기화
  $('#file').on('change', function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      $('#preview').attr('src', e.target.result).show();
      $('#previewPlaceholder').hide();
    };
    reader.readAsDataURL(file);

    // ✅ OCR 결과 영역 초기화
    $('#ocrResultBox').hide();
    $('#ocrActionButtons').hide();
    $('#ocrForm button[type="submit"]').show(); // 분석 버튼 다시 보이기
  });

  // ② 스캔 애니메이션 제어
  function startScanning() {
    $('#scan-line').show();
    $('#scan-filter').show();
  }

  function stopScanning() {
    $('#scan-line').hide();
    $('#scan-filter').hide();
  }

  // ③ OCR 요청 처리
  $('#ocrForm').on('submit', function (e) {
    e.preventDefault();

    const file = $('#file')[0].files[0];
    if (!file) {
      alert("파일을 선택해주세요.");
      return;
    }

    const formData = new FormData();
    formData.append("file", file);

    startScanning();

    fetch("/receipt", {
      method: "POST",
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        stopScanning();

        if (data.error) {
          alert(data.error);
          resetForm();
          return;
        }

        if (data.isDuplicate) {
          alert("이미 등록된 영수증입니다.");
          resetForm();
          return;
        }

        const ocr = data.ocrData || {};
        window.ocrResultCache = {
          ocr,
          ocrKeyHash: data.ocrKeyHash,
          visitDate: ocr.date,
          bizNum: ocr.bizNum
        };

        $('#storeName').text(ocr.storeName || "없음");
        $('#date').text(ocr.date || "없음");
        $('#menuNames').text((ocr.menuNames || []).join(', ') || "없음");

        $('#ocrResultBox').show();
        $('#ocrActionButtons').show();
        $('#ocrForm button[type="submit"]').hide(); // ✅ 분석 버튼 숨기기
      })
      .catch(err => {
        stopScanning();
        console.error("❌ 오류 발생:", err);
        alert("분석 중 오류가 발생했습니다.");
      });
  });

  // ④ 폼 초기화 (placeholder 포함)
  function resetForm() {
    $('#ocrForm')[0].reset();
    $('#preview').attr('src', '#').hide();
    $('#previewPlaceholder').show();
    $('#previewWrapper').hide();
    stopScanning();
    $('#ocrResultBox').hide();
    $('#ocrActionButtons').hide();
    $('#ocrForm button[type="submit"]').show(); // 분석 버튼 복구
  }

  // ⑤ 리뷰 작성 페이지로 이동
  function proceedToReview() {
    const ocr = window.ocrResultCache;
    if (!ocr?.bizNum || !ocr?.ocrKeyHash || !ocr?.visitDate) {
      alert("정보가 누락되었습니다.");
      return;
    }

    const form = document.getElementById("proceedForm");
    form.bizNum.value = ocr.bizNum;
    form.ocrKeyHash.value = ocr.ocrKeyHash;
    form.visitDate.value = ocr.visitDate;
    form.isReceiptReview.value = true;

    form.submit();
  }
</script>

<!-- COMMON SCRIPTS -->
<script src="/js/common_scripts.min.js"></script>
<script src="/js/common_func.js"></script>
<script src="/assets/validate.js"></script>

<!-- SPECIFIC SCRIPTS -->
<script src="/js/sticky_sidebar.min.js"></script>
<script src="/js/specific_listing.js"></script>

</body>
</html>