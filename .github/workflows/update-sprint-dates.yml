name: Update Sprint Dates

on:
  schedule:
    - cron: '*/10 * * * *'  # 매 10분마다 자동 실행
  workflow_dispatch:        # 수동 실행도 가능

jobs:
  update-dates:
    runs-on: ubuntu-latest

    steps:
      - name: Update Sprint Dates in GitHub Project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const projectNumber = 5;
            const org = "20250123-SSG";
            const statusFieldName = "Status";
            const startDateField = "Start Date";
            const endDateField = "End Date";
            // 오늘 날짜를 KST 기준으로 변환
            const now = new Date();
            const kstOffset = 9 * 60; // 분 단위
            const localDate = new Date(now.getTime() + kstOffset * 60 * 1000);
            const today = localDate.toISOString().split("T")[0];

            const gql = String.raw;

            // Get project info
            const queryProject = gql`
              query($org: String!) {
                organization(login: $org) {
                  projectV2(number: ${projectNumber}) {
                    id
                    fields(first: 30) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                        }
                        ... on ProjectV2IterationField {
                          id
                          name
                        }
                      }
                    }
                    items(first: 100) {
                      nodes {
                        id
                        fieldValues(first: 30) {
                          nodes {
                            ... on ProjectV2ItemFieldDateValue {
                              date
                              field {
                                name
                              }
                            }
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                name
                              }
                            }
                          }
                        }
                        content {
                          ... on Issue {
                            number
                            title
                            state
                          }
                        }
                        status: fieldValueByName(name: "${statusFieldName}") {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(queryProject, { org });
            const project = result.organization.projectV2;
            const projectId = project.id;
            const fields = project.fields.nodes;
            const items = project.items.nodes;

            const startField = fields.find(f => f.name === startDateField);
            const endField = fields.find(f => f.name === endDateField);

            if (!startField || !endField) {
              throw new Error("Start Date or End Date field not found.");
            }

            for (const item of items) {
              if (!item.content || !item.content.number) continue;

              const issueNumber = item.content.number;
              const status = item.status?.name || "";
              const isClosed = item.content.state === "CLOSED";

              let hasStart = false;
              let hasEnd = false;

              for (const f of item.fieldValues.nodes) {
                if (f.field?.name === startDateField && f.date) hasStart = true;
                if (f.field?.name === endDateField && f.date) hasEnd = true;
              }

              // 시작일 설정
              if (status === "In Progress" && !hasStart) {
                console.log(`⏱️ Setting Start Date for issue #${issueNumber} (${today})`);
                await github.graphql(gql`
                  mutation {
                    updateProjectV2ItemFieldValue(
                      input: {
                        projectId: "${projectId}",
                        itemId: "${item.id}",
                        fieldId: "${startField.id}",
                        value: { date: "${today}" }
                      }
                    ) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `);
              }

              // 종료일 설정
              if ((status === "Done" || isClosed) && !hasEnd) {
                console.log(`✅ Setting End Date for issue #${issueNumber} (${today})`);
                await github.graphql(gql`
                  mutation {
                    updateProjectV2ItemFieldValue(
                      input: {
                        projectId: "${projectId}",
                        itemId: "${item.id}",
                        fieldId: "${endField.id}",
                        value: { date: "${today}" }
                      }
                    ) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `);
              }
            }
